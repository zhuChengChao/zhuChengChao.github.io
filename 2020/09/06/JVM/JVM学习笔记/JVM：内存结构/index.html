<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/Mario.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/Mario.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="说明：在学习了 bilibili 上 黑马程序员 的课程 JVM完整教程 后做的学习笔记，总共分为5篇笔记，本文为 1&#x2F;5 篇，其余笔记地址如下：  JVM：内存结构 JVM：垃圾回收 JVM：类加载字节码-1 JVM：类加载字节码-2 JVM：内存模型">
<meta property="og:type" content="article">
<meta property="og:title" content="JVM：内存结构">
<meta property="og:url" content="http://example.com/2020/09/06/JVM/JVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%EF%BC%9A%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/index.html">
<meta property="og:site_name" content="贤余超">
<meta property="og:description" content="说明：在学习了 bilibili 上 黑马程序员 的课程 JVM完整教程 后做的学习笔记，总共分为5篇笔记，本文为 1&#x2F;5 篇，其余笔记地址如下：  JVM：内存结构 JVM：垃圾回收 JVM：类加载字节码-1 JVM：类加载字节码-2 JVM：内存模型">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2020/09/06/JVM/JVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%EF%BC%9A%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/程序计数器.PNG">
<meta property="og:image" content="http://example.com/2020/09/06/JVM/JVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%EF%BC%9A%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/虚拟机栈.PNG">
<meta property="og:image" content="http://example.com/2020/09/06/JVM/JVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%EF%BC%9A%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/本地方法栈.PNG">
<meta property="og:image" content="http://example.com/2020/09/06/JVM/JVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%EF%BC%9A%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/堆.PNG">
<meta property="og:image" content="http://example.com/2020/09/06/JVM/JVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%EF%BC%9A%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/jconsole.PNG">
<meta property="og:image" content="http://example.com/2020/09/06/JVM/JVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%EF%BC%9A%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/方法区.PNG">
<meta property="og:image" content="http://example.com/2020/09/06/JVM/JVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%EF%BC%9A%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/jvm内存结构jkd6.PNG">
<meta property="og:image" content="http://example.com/2020/09/06/JVM/JVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%EF%BC%9A%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/jvm内存结构jkd8.PNG">
<meta property="og:image" content="http://example.com/2020/09/06/JVM/JVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%EF%BC%9A%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/内存抽样器1.PNG">
<meta property="og:image" content="http://example.com/2020/09/06/JVM/JVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%EF%BC%9A%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/内存抽样器2.PNG">
<meta property="og:image" content="http://example.com/2020/09/06/JVM/JVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%EF%BC%9A%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/内存抽样器3.PNG">
<meta property="og:image" content="http://example.com/2020/09/06/JVM/JVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%EF%BC%9A%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/文件读写1.PNG">
<meta property="og:image" content="http://example.com/2020/09/06/JVM/JVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%EF%BC%9A%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/文件读写2.PNG">
<meta property="og:image" content="http://example.com/2020/09/06/JVM/JVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%EF%BC%9A%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/直接内存分配1.PNG">
<meta property="og:image" content="http://example.com/2020/09/06/JVM/JVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%EF%BC%9A%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/直接内存分配2.PNG">
<meta property="og:image" content="http://example.com/2020/09/06/JVM/JVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%EF%BC%9A%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/直接内存分配3.PNG">
<meta property="article:published_time" content="2020-09-06T02:24:00.000Z">
<meta property="article:modified_time" content="2020-09-06T02:24:00.000Z">
<meta property="article:author" content="ZhuCC">
<meta property="article:tag" content="学习笔记">
<meta property="article:tag" content="JVM">
<meta property="article:tag" content="Java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2020/09/06/JVM/JVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%EF%BC%9A%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/程序计数器.PNG">

<link rel="canonical" href="http://example.com/2020/09/06/JVM/JVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%EF%BC%9A%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>JVM：内存结构 | 贤余超</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>
	<a target="_blank" rel="noopener" href="https://github.com/zhuChengChao" class="github-corner" aria-label="View source on GitHub">
	<svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true">
	<path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
	<path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
	<path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path>
	</svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">贤余超</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">一位底层码农 :-)</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">69</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">14</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">161</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/09/06/JVM/JVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%EF%BC%9A%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/%E5%A4%B4%E5%83%8F.jpg">
      <meta itemprop="name" content="ZhuCC">
      <meta itemprop="description" content="不急不躁。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="贤余超">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          JVM：内存结构
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-06 10:24:00" itemprop="dateCreated datePublished" datetime="2020-09-06T10:24:00+08:00">2020-09-06</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JVM/" itemprop="url" rel="index"><span itemprop="name">JVM</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2020/09/06/JVM/JVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%EF%BC%9A%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/09/06/JVM/JVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%EF%BC%9A%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>37k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>33 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>说明：在学习了 bilibili 上 <strong><a href>黑马程序员</a></strong> 的课程 <a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1yE411Z7AP">JVM完整教程</a> 后做的学习笔记，总共分为5篇笔记，本文为 1/5 篇，其余笔记地址如下：</p>
<ul>
<li><a href>JVM：内存结构</a></li>
<li><a href>JVM：垃圾回收</a></li>
<li><a href>JVM：类加载字节码-1</a></li>
<li><a href>JVM：类加载字节码-2</a></li>
<li><a href>JVM：内存模型</a></li>
</ul>
<span id="more"></span>
<h1 id="jvm内存结构">JVM：内存结构</h1>
<h3 id="内容">内容</h3>
<ol type="1">
<li>程序计数器</li>
<li>虚拟机栈</li>
<li>本地方法栈</li>
<li>堆</li>
<li>方法区</li>
<li>直接内存</li>
</ol>
<h2 id="程序计数器">1. 程序计数器</h2>
<p><img src="/2020/09/06/JVM/JVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%EF%BC%9A%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/程序计数器.PNG" alt="程序计数器"></p>
<h3 id="定义">1.1 定义</h3>
<p>Program Counter Register 程序计数器（寄存器）</p>
<ul>
<li>作用：是记住下一条 JVM 指令的执行地址</li>
<li>特点
<ul>
<li>是线程私有的</li>
<li>不会存在内存溢出</li>
</ul></li>
</ul>
<h3 id="作用">1.2 作用</h3>
<p><code>JVM指令 -&gt; 解释器 -&gt; 机器码 -&gt; CPU执行</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 二进制字节码 JVM指令        // java源代码</span></span><br><span class="line"><span class="number">0</span>: getstatic #<span class="number">20</span> 			<span class="comment">// PrintStream out = System.out;</span></span><br><span class="line"><span class="number">3</span>: astore_1 				<span class="comment">// --</span></span><br><span class="line"><span class="number">4</span>: aload_1 					<span class="comment">// out.println(1);</span></span><br><span class="line"><span class="number">5</span>: iconst_1					<span class="comment">// --</span></span><br><span class="line"><span class="number">6</span>: invokevirtual #<span class="number">26</span>		<span class="comment">// --</span></span><br><span class="line"><span class="number">9</span>: aload_1 					<span class="comment">// out.println(2);</span></span><br><span class="line"><span class="number">10</span>: iconst_2 				<span class="comment">// --</span></span><br><span class="line"><span class="number">11</span>: invokevirtual #<span class="number">26</span> 		<span class="comment">// --</span></span><br><span class="line"><span class="number">14</span>: aload_1 				<span class="comment">// out.println(3);</span></span><br><span class="line"><span class="number">15</span>: iconst_3 				<span class="comment">// --</span></span><br><span class="line"><span class="number">16</span>: invokevirtual #<span class="number">26</span> 		<span class="comment">// --</span></span><br><span class="line"><span class="number">19</span>: aload_1 				<span class="comment">// out.println(4);</span></span><br><span class="line"><span class="number">20</span>: iconst_4 				<span class="comment">// --</span></span><br><span class="line"><span class="number">21</span>: invokevirtual #<span class="number">26</span> 		<span class="comment">// --</span></span><br><span class="line"><span class="number">24</span>: aload_1 				<span class="comment">// out.println(5);</span></span><br><span class="line"><span class="number">25</span>: iconst_5 				<span class="comment">// --</span></span><br><span class="line"><span class="number">26</span>: invokevirtual #<span class="number">26</span> 		<span class="comment">// --</span></span><br><span class="line"><span class="number">29</span>: <span class="keyword">return</span></span><br></pre></td></tr></table></figure>
<h2 id="虚拟机栈">2. 虚拟机栈</h2>
<p><img src="/2020/09/06/JVM/JVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%EF%BC%9A%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/虚拟机栈.PNG" alt="虚拟机栈"></p>
<h3 id="定义-1">2.1 定义</h3>
<p>Java Virtual Machine Stacks，Java 虚拟机栈</p>
<ul>
<li><p>每个线程运行时所需要的内存，称为虚拟机栈；</p></li>
<li>每个线程由多个<strong>栈帧（Frame）</strong>组成，对应着每次方法调用时所占用的内存；</li>
<li>每个线程<strong>只能有一个活动栈帧</strong>，对应着当前正在执行的那个方法；</li>
<li><p>栈帧：每个方法运行时需要的内存，例如方法的参数，局部变量，返回地址等都需要占用内存；</p></li>
</ul>
<p><strong>问题辨析</strong></p>
<ol type="1">
<li><p>垃圾回收是否涉及栈内存？</p>
<p>答：不会，栈内的栈帧内存，在方法调用结束后都会出栈；<strong>垃圾回收只是涉及到堆内存</strong>。</p></li>
<li><p>栈内存分配越大越好吗？</p>
<p>答：不是，栈内存划分越大会导致线程数减少，由于物理内存大小是一定的，线程会使用到栈内存，因此栈内存越大则会可运行线程数减少。</p></li>
<li><p>方法内的局部变量是否线程安全？</p>
<ul>
<li>如果方法内局部变量没有逃离方法的作用访问，它是线程安全的</li>
<li>如果是局部变量引用了对象，并逃离方法的作用范围，需要考虑线程安全</li>
</ul></li>
</ol>
<h3 id="栈内存溢出">2.2 栈内存溢出</h3>
<ul>
<li>栈帧过多导致栈内存溢出</li>
<li>栈帧过大导致栈内存溢出</li>
</ul>
<h4 id="案例递归爆栈">案例：递归爆栈</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> count;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        method1();</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Throwable e)&#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        System.out.println(count);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 一直入递归函数，没有出递归函数的条件</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">method1</span><span class="params">()</span></span>&#123;</span><br><span class="line">    count++;</span><br><span class="line">    method1();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">java.lang.StackOverflowError</span><br><span class="line">	at cn.xyc.Test01.method1(Test01.java:<span class="number">19</span>)</span><br><span class="line">	at cn.xyc.Test01.method1(Test01.java:<span class="number">19</span>)</span><br><span class="line">	at cn.xyc.Test01.method1(Test01.java:<span class="number">19</span>)</span><br><span class="line">	...</span><br><span class="line"><span class="number">23564</span></span><br></pre></td></tr></table></figure>
<p><strong>修改栈内存大小：</strong></p>
<blockquote>
<p>在 IDEA 中打开程序的运行设置 <code>Edit Configurations...</code></p>
<p>在<code>VM options</code>加上修改栈内存大小的参数<code>-Xss256k</code>，</p>
</blockquote>
<p>重新运行代码，输出如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">java.lang.StackOverflowError</span><br><span class="line">	at cn.xyc.Test01.method1(Test01.java:<span class="number">19</span>)</span><br><span class="line">	at cn.xyc.Test01.method1(Test01.java:<span class="number">19</span>)</span><br><span class="line">	at cn.xyc.Test01.method1(Test01.java:<span class="number">19</span>)</span><br><span class="line">	...</span><br><span class="line"><span class="number">4053</span>  <span class="comment">// 栈变小了</span></span><br></pre></td></tr></table></figure>
<h4 id="案例json-数据转换">案例：json 数据转换</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test02</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> JsonProcessingException </span>&#123;</span><br><span class="line">        Dept d = <span class="keyword">new</span> Dept();</span><br><span class="line">        d.setName(<span class="string">&quot;Market&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Emp e1 = <span class="keyword">new</span> Emp();</span><br><span class="line">        e1.setName(<span class="string">&quot;zhang&quot;</span>);</span><br><span class="line">        e1.setDept(d);</span><br><span class="line"></span><br><span class="line">        Emp e2 = <span class="keyword">new</span> Emp();</span><br><span class="line">        e2.setName(<span class="string">&quot;li&quot;</span>);</span><br><span class="line">        e2.setDept(d);</span><br><span class="line"></span><br><span class="line">        d.setEmps(Arrays.asList(e1, e2));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// &#123; name: &#x27;Market&#x27;, emps: [&#123; name:&#x27;zhang&#x27;, dept:&#123; name:&#x27;&#x27;, emps: [ &#123;&#125;]&#125; &#125;,] &#125;</span></span><br><span class="line">        ObjectMapper mapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        System.out.println(mapper.writeValueAsString(d));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Emp</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Dept dept;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Dept <span class="title">getDept</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> dept;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDept</span><span class="params">(Dept dept)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.dept = dept;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dept</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Emp&gt; emps;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Emp&gt; <span class="title">getEmps</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> emps;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEmps</span><span class="params">(List&lt;Emp&gt; emps)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.emps = emps;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出报错：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Infinite <span class="title">recursion</span> <span class="params">(StackOverflowError)</span></span></span><br></pre></td></tr></table></figure>
<p>修改：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在emp类中的成员属性Dept上加上</span></span><br><span class="line"><span class="meta">@JsonIgnore</span></span><br><span class="line"><span class="keyword">private</span> Dept dept;</span><br></pre></td></tr></table></figure>
<p>修改完成后输出：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;Market&quot;</span>,<span class="string">&quot;emps&quot;</span>:[&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;zhang&quot;</span>&#125;,&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;li&quot;</span>&#125;]&#125;</span><br></pre></td></tr></table></figure>
<h3 id="线程运行诊断">2.3 线程运行诊断</h3>
<h4 id="案例1cpu占用过多">案例1：CPU占用过多</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示 cpu 占用过高</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo1_16</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">null</span>, () -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;1...&quot;</span>);</span><br><span class="line">            <span class="keyword">while</span>(<span class="keyword">true</span>) &#123; &#125;  <span class="comment">// 死循环，导致cpu一直空转</span></span><br><span class="line">        &#125;, <span class="string">&quot;thread1&quot;</span>).start();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">null</span>, () -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;2...&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000000L</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;thread2&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">null</span>, () -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;3...&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000000L</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;thread3&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>定位：</strong></p>
<ul>
<li><p>用 top 定位哪个进程对 cpu 的占用过高；</p></li>
<li><p><code>ps H -eo pid, tid, %cpu | grep 进程id</code> （用 ps 命令进一步定位是那个线程引起的cpu占用过高）</p>
<blockquote>
<p>pid：进程 ID</p>
<p>tid：线程 ID</p>
<p>%cpu：cpu占用情况</p>
</blockquote></li>
<li><p>jstack 进程 id</p>
<ul>
<li>jps 查看所有 java 进程</li>
<li><code>jstack &lt;PID&gt;</code> 查看某个 Java 进程（PID）的所有线程状态</li>
<li>然后可以根据 <strong>线程id-tid</strong> 找到有问题的线程，进一步定位到问题代码的源码行号</li>
</ul></li>
</ul>
<h4 id="案例2程序运行很长时间没有结果">案例2：程序运行很长时间没有结果</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示线程死锁</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span></span>&#123;&#125;;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo1_3</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> A a = <span class="keyword">new</span> A();</span><br><span class="line">    <span class="keyword">static</span> B b = <span class="keyword">new</span> B();</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (a) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">synchronized</span> (b) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;我获得了 a 和 b&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (b) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (a) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;我获得了 a 和 b&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>通过 jps 查看当前的 java 进程</p></li>
<li><p><code>jstack &lt;PID&gt;</code> 查看某个 Java 进程（PID）的所有线程状态</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Found one Java-level deadlock:</span><br><span class="line">=============================</span><br><span class="line"><span class="string">&quot;Thread-1&quot;</span>:</span><br><span class="line">  waiting to lock monitor <span class="number">0x000000001c3edbd8</span> (object <span class="number">0x000000076b2aa738</span>, a cn.xyc.A),</span><br><span class="line">  which is held by <span class="string">&quot;Thread-0&quot;</span></span><br><span class="line"><span class="string">&quot;Thread-0&quot;</span>:</span><br><span class="line">  waiting to lock monitor <span class="number">0x000000001c3f0728</span> (object <span class="number">0x000000076b2ac158</span>, a cn.xyc.B),</span><br><span class="line">  which is held by <span class="string">&quot;Thread-1&quot;</span></span><br><span class="line"></span><br><span class="line">Java stack information <span class="keyword">for</span> the threads listed above:</span><br><span class="line">===================================================</span><br><span class="line"><span class="string">&quot;Thread-1&quot;</span>:</span><br><span class="line">        at cn.xyc.Test4.lambda$main$<span class="number">1</span>(Test4.java:<span class="number">24</span>)</span><br><span class="line">        - waiting to lock &lt;<span class="number">0x000000076b2aa738</span>&gt; (a cn.xyc.A)</span><br><span class="line">        - locked &lt;<span class="number">0x000000076b2ac158</span>&gt; (a cn.xyc.B)</span><br><span class="line">        at cn.xyc.Test4$$Lambda$<span class="number">2</span>/<span class="number">2093631819.</span>run(Unknown Source)</span><br><span class="line">        at java.lang.Thread.run(Thread.java:<span class="number">748</span>)</span><br><span class="line"><span class="string">&quot;Thread-0&quot;</span>:</span><br><span class="line">        at cn.xyc.Test4.lambda$main$<span class="number">0</span>(Test4.java:<span class="number">16</span>)</span><br><span class="line">        - waiting to lock &lt;<span class="number">0x000000076b2ac158</span>&gt; (a cn.xyc.B)</span><br><span class="line">        - locked &lt;<span class="number">0x000000076b2aa738</span>&gt; (a cn.xyc.A)</span><br><span class="line">        at cn.xyc.Test4$$Lambda$<span class="number">1</span>/<span class="number">1023892928.</span>run(Unknown Source)</span><br><span class="line">        at java.lang.Thread.run(Thread.java:<span class="number">748</span>)</span><br><span class="line"></span><br><span class="line">Found <span class="number">1</span> deadlock.</span><br></pre></td></tr></table></figure>
<p>可以看到出现了死锁，Thread-1 需要的锁被 Thread-0 持有， Thread-0 需要的锁被 Thread-1 持有，出现死锁的情况。</p></li>
</ul>
<h2 id="本地方法栈">3. 本地方法栈</h2>
<p><img src="/2020/09/06/JVM/JVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%EF%BC%9A%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/本地方法栈.PNG" alt="本地方法栈"></p>
<p><strong>本地方法</strong>：不是由 Java 代码编写的方法，而由 C/C++ 编写的，与底层操作系统进行交互的方法。</p>
<p>例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Object类中，这些带native的方法</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">native</span> Object <span class="title">clone</span><span class="params">()</span> <span class="keyword">throws</span> CloneNotSupportedException</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<h2 id="堆">4. 堆</h2>
<p><img src="/2020/09/06/JVM/JVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%EF%BC%9A%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/堆.PNG" alt="堆"></p>
<h3 id="定义-2">4.1 定义</h3>
<p>Heap 堆</p>
<ul>
<li>通过 new 关键字，创建对象都会使用堆内存</li>
</ul>
<p>特点</p>
<ul>
<li>它是线程共享的，堆中对象都需要考虑线程安全的问题</li>
<li>有垃圾回收机制</li>
</ul>
<h3 id="堆内存溢出">4.2 堆内存溢出</h3>
<p><strong>演示：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示堆内存溢出 java.lang.OutOfMemoryError: Java heap space</span></span><br><span class="line"><span class="comment"> * -Xmx8m  控制堆空间的最大空间值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo1_5</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            String a = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                list.add(a); <span class="comment">// hello, hellohello, hellohellohellohello ...</span></span><br><span class="line">                a = a + a;  <span class="comment">// hellohellohellohello</span></span><br><span class="line">                i++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            System.out.println(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java.lang.OutOfMemoryError: Java heap space</span><br><span class="line"><span class="number">26</span></span><br></pre></td></tr></table></figure>
<h3 id="堆内存诊断">4.3 堆内存诊断</h3>
<ol type="1">
<li><code>jps</code> 工具：查看当前系统中有哪些 java 进程</li>
<li><code>jmap</code> 工具：查看堆内存占用情况 <code>jmap -heap 进程id</code>，只能查看一个时刻</li>
<li><code>jconsole</code> 工具：图形界面的，多功能的监测工具，可以连续监测</li>
</ol>
<h4 id="案例1工具使用演示">案例1：工具使用演示</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示堆内存</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo1_4</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;1...&quot;</span>);</span><br><span class="line">        Thread.sleep(<span class="number">30000</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] array = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span> * <span class="number">1024</span> * <span class="number">10</span>]; <span class="comment">// 10 Mb</span></span><br><span class="line">        System.out.println(<span class="string">&quot;2...&quot;</span>);</span><br><span class="line">        Thread.sleep(<span class="number">20000</span>);</span><br><span class="line">        array = <span class="keyword">null</span>;</span><br><span class="line">        System.gc();  <span class="comment">// 调用gc方法进行垃圾回收</span></span><br><span class="line">        System.out.println(<span class="string">&quot;3...&quot;</span>);</span><br><span class="line">        Thread.sleep(<span class="number">1000000L</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="jmap-工具使用">jmap 工具使用</h5>
<ol type="1">
<li><p>运行上述程序</p></li>
<li><p>输入 jps 查看当前 java 进程</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">7760</span><br><span class="line">13380  Jps</span><br><span class="line">10776  RemoteMavenServer</span><br><span class="line">6556   Test6</span><br><span class="line">13864  Launcher</span><br></pre></td></tr></table></figure></li>
<li><p>不同时刻使用 jmap 命令</p>
<ol type="1">
<li>输出1时的时间点快照：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\ZhuCC&gt;jmap -heap <span class="number">6556</span></span><br><span class="line">Attaching to process ID <span class="number">6556</span>, please wait...</span><br><span class="line">Debugger attached successfully.</span><br><span class="line">Server compiler detected.</span><br><span class="line">JVM version is <span class="number">25.241</span>-b07</span><br><span class="line"></span><br><span class="line">using thread-local object allocation.</span><br><span class="line">Parallel GC with <span class="number">4</span> thread(s)</span><br><span class="line"></span><br><span class="line">Heap Configuration:   <span class="comment">// 堆配置信息</span></span><br><span class="line">   MinHeapFreeRatio         = <span class="number">0</span></span><br><span class="line">   MaxHeapFreeRatio         = <span class="number">100</span></span><br><span class="line">   MaxHeapSize              = <span class="number">4278190080</span> (<span class="number">4080.</span>0MB)  <span class="comment">// 最大堆内存</span></span><br><span class="line">   NewSize                  = <span class="number">89128960</span> (<span class="number">85.</span>0MB)</span><br><span class="line">   MaxNewSize               = <span class="number">1426063360</span> (<span class="number">1360.</span>0MB)</span><br><span class="line">   OldSize                  = <span class="number">179306496</span> (<span class="number">171.</span>0MB)</span><br><span class="line">   NewRatio                 = <span class="number">2</span></span><br><span class="line">   SurvivorRatio            = <span class="number">8</span></span><br><span class="line">   MetaspaceSize            = <span class="number">21807104</span> (<span class="number">20.</span>796875MB)</span><br><span class="line">   CompressedClassSpaceSize = <span class="number">1073741824</span> (<span class="number">1024.</span>0MB)</span><br><span class="line">   MaxMetaspaceSize         = <span class="number">17592186044415</span> MB</span><br><span class="line">   G1HeapRegionSize         = <span class="number">0</span> (<span class="number">0.</span>0MB)</span><br><span class="line"></span><br><span class="line">Heap Usage:  		 <span class="comment">// 堆内存占用</span></span><br><span class="line">PS Young Generation  </span><br><span class="line">Eden Space:</span><br><span class="line">   capacity = <span class="number">67108864</span> (<span class="number">64.</span>0MB)</span><br><span class="line">   used     = <span class="number">5370928</span> (<span class="number">5.</span>1221160888671875MB)  <span class="comment">// 对比下面</span></span><br><span class="line">   free     = <span class="number">61737936</span> (<span class="number">58.</span>87788391113281MB)</span><br><span class="line">   <span class="number">8.00330638885498</span>% used</span><br><span class="line">From Space:</span><br><span class="line">   capacity = <span class="number">11010048</span> (<span class="number">10.</span>5MB)</span><br><span class="line">   used     = <span class="number">0</span> (<span class="number">0.</span>0MB)</span><br><span class="line">   free     = <span class="number">11010048</span> (<span class="number">10.</span>5MB)</span><br><span class="line">   <span class="number">0.0</span>% used</span><br><span class="line">To Space:</span><br><span class="line">   capacity = <span class="number">11010048</span> (<span class="number">10.</span>5MB)</span><br><span class="line">   used     = <span class="number">0</span> (<span class="number">0.</span>0MB)</span><br><span class="line">   free     = <span class="number">11010048</span> (<span class="number">10.</span>5MB)</span><br><span class="line">   <span class="number">0.0</span>% used</span><br><span class="line">PS Old Generation</span><br><span class="line">   capacity = <span class="number">179306496</span> (<span class="number">171.</span>0MB)</span><br><span class="line">   used     = <span class="number">0</span> (<span class="number">0.</span>0MB)</span><br><span class="line">   free     = <span class="number">179306496</span> (<span class="number">171.</span>0MB)</span><br><span class="line">   <span class="number">0.0</span>% used</span><br><span class="line"></span><br><span class="line"><span class="number">1759</span> interned Strings occupying <span class="number">157688</span> bytes.</span><br></pre></td></tr></table></figure>
<ol start="2" type="1">
<li>输出2时的时间点快照：这时<code>byte[] array</code>已经被创建了</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\ZhuCC&gt;jmap -heap <span class="number">6556</span></span><br><span class="line">Attaching to process ID <span class="number">6556</span>, please wait...</span><br><span class="line">Debugger attached successfully.</span><br><span class="line">Server compiler detected.</span><br><span class="line">JVM version is <span class="number">25.241</span>-b07</span><br><span class="line"></span><br><span class="line">using thread-local object allocation.</span><br><span class="line">Parallel GC with <span class="number">4</span> thread(s)</span><br><span class="line"></span><br><span class="line">Heap Configuration:</span><br><span class="line">   MinHeapFreeRatio         = <span class="number">0</span></span><br><span class="line">   MaxHeapFreeRatio         = <span class="number">100</span></span><br><span class="line">   MaxHeapSize              = <span class="number">4278190080</span> (<span class="number">4080.</span>0MB)</span><br><span class="line">   NewSize                  = <span class="number">89128960</span> (<span class="number">85.</span>0MB)</span><br><span class="line">   MaxNewSize               = <span class="number">1426063360</span> (<span class="number">1360.</span>0MB)</span><br><span class="line">   OldSize                  = <span class="number">179306496</span> (<span class="number">171.</span>0MB)</span><br><span class="line">   NewRatio                 = <span class="number">2</span></span><br><span class="line">   SurvivorRatio            = <span class="number">8</span></span><br><span class="line">   MetaspaceSize            = <span class="number">21807104</span> (<span class="number">20.</span>796875MB)</span><br><span class="line">   CompressedClassSpaceSize = <span class="number">1073741824</span> (<span class="number">1024.</span>0MB)</span><br><span class="line">   MaxMetaspaceSize         = <span class="number">17592186044415</span> MB</span><br><span class="line">   G1HeapRegionSize         = <span class="number">0</span> (<span class="number">0.</span>0MB)</span><br><span class="line"></span><br><span class="line">Heap Usage:</span><br><span class="line">PS Young Generation</span><br><span class="line">Eden Space:</span><br><span class="line">   capacity = <span class="number">67108864</span> (<span class="number">64.</span>0MB)</span><br><span class="line">   <span class="comment">// 对比上面，这里的used已经增加了10Mb空间了，这就是新创建的byte数组所占用的空间</span></span><br><span class="line">   used     = <span class="number">15856704</span> (<span class="number">15.</span>12213134765625MB)  </span><br><span class="line">   free     = <span class="number">51252160</span> (<span class="number">48.</span>87786865234375MB)</span><br><span class="line">   <span class="number">23.62833023071289</span>% used</span><br><span class="line">From Space:</span><br><span class="line">   capacity = <span class="number">11010048</span> (<span class="number">10.</span>5MB)</span><br><span class="line">   used     = <span class="number">0</span> (<span class="number">0.</span>0MB)</span><br><span class="line">   free     = <span class="number">11010048</span> (<span class="number">10.</span>5MB)</span><br><span class="line">   <span class="number">0.0</span>% used</span><br><span class="line">To Space:</span><br><span class="line">   capacity = <span class="number">11010048</span> (<span class="number">10.</span>5MB)</span><br><span class="line">   used     = <span class="number">0</span> (<span class="number">0.</span>0MB)</span><br><span class="line">   free     = <span class="number">11010048</span> (<span class="number">10.</span>5MB)</span><br><span class="line">   <span class="number">0.0</span>% used</span><br><span class="line">PS Old Generation</span><br><span class="line">   capacity = <span class="number">179306496</span> (<span class="number">171.</span>0MB)</span><br><span class="line">   used     = <span class="number">0</span> (<span class="number">0.</span>0MB)</span><br><span class="line">   free     = <span class="number">179306496</span> (<span class="number">171.</span>0MB)</span><br><span class="line">   <span class="number">0.0</span>% used</span><br><span class="line"></span><br><span class="line"><span class="number">1760</span> interned Strings occupying <span class="number">157736</span> bytes.</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">   </span><br><span class="line">3. 输出3时的时间点快照：这时`byte[] array`已经被垃圾回收了</span><br><span class="line">   </span><br><span class="line">   ```java</span><br><span class="line">   C:\Users\ZhuCC&gt;jmap -heap 6556</span><br><span class="line">   Attaching to process ID 6556, please wait...</span><br><span class="line">   Debugger attached successfully.</span><br><span class="line">   Server compiler detected.</span><br><span class="line">   JVM version is 25.241-b07</span><br><span class="line">   </span><br><span class="line">   using thread-local object allocation.</span><br><span class="line">   Parallel GC with 4 thread(s)</span><br><span class="line">   </span><br><span class="line">   Heap Configuration:</span><br><span class="line">      MinHeapFreeRatio         = 0</span><br><span class="line">      MaxHeapFreeRatio         = 100</span><br><span class="line">      MaxHeapSize              = 4278190080 (4080.0MB)</span><br><span class="line">      NewSize                  = 89128960 (85.0MB)</span><br><span class="line">      MaxNewSize               = 1426063360 (1360.0MB)</span><br><span class="line">      OldSize                  = 179306496 (171.0MB)</span><br><span class="line">      NewRatio                 = 2</span><br><span class="line">      SurvivorRatio            = 8</span><br><span class="line">      MetaspaceSize            = 21807104 (20.796875MB)</span><br><span class="line">      CompressedClassSpaceSize = 1073741824 (1024.0MB)</span><br><span class="line">      MaxMetaspaceSize         = 17592186044415 MB</span><br><span class="line">      G1HeapRegionSize         = 0 (0.0MB)</span><br><span class="line">   </span><br><span class="line">   Heap Usage:</span><br><span class="line">   PS Young Generation</span><br><span class="line">   Eden Space:</span><br><span class="line">      capacity = 67108864 (64.0MB)</span><br><span class="line">      // byte数组已经被释放了，进行了垃圾回收，使用量又变小了</span><br><span class="line">      used     = 1342200 (1.2800216674804688MB)  </span><br><span class="line">      free     = 65766664 (62.71997833251953MB)</span><br><span class="line">      2.0000338554382324% used</span><br><span class="line">   From Space:</span><br><span class="line">      capacity = 11010048 (10.5MB)</span><br><span class="line">      used     = 0 (0.0MB)</span><br><span class="line">      free     = 11010048 (10.5MB)</span><br><span class="line">      0.0% used</span><br><span class="line">   To Space:</span><br><span class="line">      capacity = 11010048 (10.5MB)</span><br><span class="line">      used     = 0 (0.0MB)</span><br><span class="line">      free     = 11010048 (10.5MB)</span><br><span class="line">      0.0% used</span><br><span class="line">   PS Old Generation</span><br><span class="line">      capacity = 179306496 (171.0MB)</span><br><span class="line">      used     = 665560 (0.6347274780273438MB)</span><br><span class="line">      free     = 178640936 (170.36527252197266MB)</span><br><span class="line">      0.3711856596651133% used</span><br><span class="line">   </span><br><span class="line">   1746 interned Strings occupying 156744 bytes.</span><br></pre></td></tr></table></figure></li>
</ol>
<h5 id="jconsole-工具使用">jconsole 工具使用</h5>
<ol type="1">
<li><p>演示程序运行；</p></li>
<li><p>控制台输入 jconsole ，选择相应 java 进程，选择不安全连接</p></li>
<li><p>监视情况如下：</p>
<p><img src="/2020/09/06/JVM/JVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%EF%BC%9A%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/jconsole.PNG" alt="jconsole"></p></li>
</ol>
<h4 id="案例2">案例2：</h4>
<p>垃圾回收后，内存占用仍然很高</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示查看对象个数 堆转储 dump</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo1_13</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        List&lt;Student&gt; students = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">200</span>; i++) &#123;</span><br><span class="line">            students.add(<span class="keyword">new</span> Student());</span><br><span class="line">        &#125;</span><br><span class="line">        Thread.sleep(<span class="number">1000000000L</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] big = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>*<span class="number">1024</span>];  <span class="comment">// 1Mb</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过 <code>jmap -heap &lt;PID&gt;</code> 查看</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\ZhuCC&gt;jmap -heap <span class="number">15116</span></span><br><span class="line">Attaching to process ID <span class="number">15116</span>, please wait...</span><br><span class="line">Debugger attached successfully.</span><br><span class="line">Server compiler detected.</span><br><span class="line">JVM version is <span class="number">25.241</span>-b07</span><br><span class="line"></span><br><span class="line">using thread-local object allocation.</span><br><span class="line">Parallel GC with <span class="number">4</span> thread(s)</span><br><span class="line"></span><br><span class="line">Heap Configuration:</span><br><span class="line">   MinHeapFreeRatio         = <span class="number">0</span></span><br><span class="line">   MaxHeapFreeRatio         = <span class="number">100</span></span><br><span class="line">   MaxHeapSize              = <span class="number">4278190080</span> (<span class="number">4080.</span>0MB)</span><br><span class="line">   NewSize                  = <span class="number">89128960</span> (<span class="number">85.</span>0MB)</span><br><span class="line">   MaxNewSize               = <span class="number">1426063360</span> (<span class="number">1360.</span>0MB)</span><br><span class="line">   OldSize                  = <span class="number">179306496</span> (<span class="number">171.</span>0MB)</span><br><span class="line">   NewRatio                 = <span class="number">2</span></span><br><span class="line">   SurvivorRatio            = <span class="number">8</span></span><br><span class="line">   MetaspaceSize            = <span class="number">21807104</span> (<span class="number">20.</span>796875MB)</span><br><span class="line">   CompressedClassSpaceSize = <span class="number">1073741824</span> (<span class="number">1024.</span>0MB)</span><br><span class="line">   MaxMetaspaceSize         = <span class="number">17592186044415</span> MB</span><br><span class="line">   G1HeapRegionSize         = <span class="number">0</span> (<span class="number">0.</span>0MB)</span><br><span class="line"></span><br><span class="line">Heap Usage:</span><br><span class="line">PS Young Generation</span><br><span class="line">Eden Space:</span><br><span class="line">   capacity = <span class="number">241172480</span> (<span class="number">230.</span>0MB)</span><br><span class="line">   used     = <span class="number">28806776</span> (<span class="number">27.</span>47228240966797MB)</span><br><span class="line">   free     = <span class="number">212365704</span> (<span class="number">202.</span>52771759033203MB)</span><br><span class="line">   <span class="number">11.944470612899117</span>% used</span><br><span class="line">From Space:</span><br><span class="line">   capacity = <span class="number">11010048</span> (<span class="number">10.</span>5MB)</span><br><span class="line">   used     = <span class="number">10616992</span> (<span class="number">10.</span>125152587890625MB)</span><br><span class="line">   free     = <span class="number">393056</span> (<span class="number">0.</span>374847412109375MB)</span><br><span class="line">   <span class="number">96.43002464657738</span>% used</span><br><span class="line">To Space:</span><br><span class="line">   capacity = <span class="number">11010048</span> (<span class="number">10.</span>5MB)</span><br><span class="line">   used     = <span class="number">0</span> (<span class="number">0.</span>0MB)</span><br><span class="line">   free     = <span class="number">11010048</span> (<span class="number">10.</span>5MB)</span><br><span class="line">   <span class="number">0.0</span>% used</span><br><span class="line">PS Old Generation</span><br><span class="line">   capacity = <span class="number">280494080</span> (<span class="number">267.</span>5MB)</span><br><span class="line">   <span class="comment">// 老年代中占用了很高的内存使用量</span></span><br><span class="line">   used     = <span class="number">186248584</span> (<span class="number">177.</span>62049102783203MB)  </span><br><span class="line">   free     = <span class="number">94245496</span> (<span class="number">89.</span>87950897216797MB)</span><br><span class="line">   <span class="number">66.40018356180637</span>% used</span><br><span class="line"></span><br><span class="line"><span class="number">1743</span> interned Strings occupying <span class="number">156600</span> bytes.</span><br></pre></td></tr></table></figure>
<h5 id="jvisualvm-工具">jvisualvm 工具</h5>
<blockquote>
<p>j + visual + vm</p>
</blockquote>
<ol type="1">
<li>控制台输入命令：<code>jvisualvm</code></li>
<li>选择对于的 java 进程</li>
<li><code>监视栏</code>中的 <code>堆Dump</code>可以抓取堆的快照
<ol type="1">
<li>其中有功能可以查找 <code>堆中最大的对象</code></li>
<li>可以看到<code>ArrayList</code>对象占用的内存最大，点击进入查看详细信息</li>
<li>又可以看到<code>ArrayList</code>中的<code>elementData</code>存储了 <code>Student</code>对象，对象内的 byte[] 属性大约占用了1Mb的空间</li>
<li>而<code>ArrayList</code>中有200个<code>Student</code> 对象，即占用了200Mb的空间大小</li>
</ol></li>
</ol>
<h2 id="方法区">5. 方法区</h2>
<p><img src="/2020/09/06/JVM/JVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%EF%BC%9A%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/方法区.PNG" alt="方法区"></p>
<h3 id="定义-3">5.1 定义</h3>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html">JVM规范-方法区定义</a></p>
<p>The Java Virtual Machine has a <em>method area</em> that is shared among all Java Virtual Machine threads. （Java虚拟机有一个在所有Java虚拟机线程之间共享的方法区域。）The method area is analogous to the storage area for compiled code of a conventional language or analogous to the &quot;text&quot; segment in an operating system process. It stores per-class structures such as the run-time constant pool, field and method data, and the code for methods and constructors, including the special methods (<a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html#jvms-2.9">§2.9</a>) used in class and instance initialization and interface initialization.（它存储每个类的结构，如运行时常量池、字段和方法数据，以及方法和构造函数的代码，包括类和实例初始化以及接口初始化中使用的特殊方法。）</p>
<p>The method area is created on virtual machine start-up.（方法区域是在虚拟机启动时创建的。） Although the method area is logically part of the heap, simple implementations may choose not to either garbage collect or compact it. This specification does not mandate the location of the method area or the policies used to manage compiled code. The method area may be of a fixed size or may be expanded as required by the computation and may be contracted if a larger method area becomes unnecessary. The memory for the method area does not need to be contiguous.</p>
<p>A Java Virtual Machine implementation may provide the programmer or the user control over the initial size of the method area, as well as, in the case of a varying-size method area, control over the maximum and minimum method area size.</p>
<p>The following exceptional condition is associated with the method area:</p>
<ul>
<li>If memory in the method area cannot be made available to satisfy an allocation request, the Java Virtual Machine throws an <code>OutOfMemoryError</code>.</li>
</ul>
<h3 id="组成">5.2 组成</h3>
<p>JDK1.6 方法区采用了永久代来实现</p>
<p><img src="/2020/09/06/JVM/JVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%EF%BC%9A%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/jvm内存结构jkd6.PNG" alt="jvm内存结构jkd6"></p>
<p>JDK8 不采用永久代，其实现改为了元空间，不存在于堆内存了，即不由 JVM 对其进行管理了</p>
<p><img src="/2020/09/06/JVM/JVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%EF%BC%9A%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/jvm内存结构jkd8.PNG" alt="jvm内存结构jkd8"></p>
<h3 id="方法区内存溢出">5.3 方法区内存溢出</h3>
<p>1.8 以前会导致永久代内存溢出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示永久代内存溢出 java.lang.OutOfMemoryError: PermGen space</span></span><br><span class="line"><span class="comment"> * -XX:MaxPermSize=8m  永久代内存大小</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo1_8</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span> </span>&#123; <span class="comment">// 可以用来加载类的二进制字节码</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> j = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Demo1_8 test = <span class="keyword">new</span> Demo1_8();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++, j++) &#123;</span><br><span class="line">                <span class="comment">// ClassWriter 作用是生成类的二进制字节码</span></span><br><span class="line">                ClassWriter cw = <span class="keyword">new</span> ClassWriter(<span class="number">0</span>);</span><br><span class="line">                <span class="comment">// 版本号， public， 类名, 包名, 父类， 接口</span></span><br><span class="line">                cw.visit(Opcodes.V1_8, Opcodes.ACC_PUBLIC, <span class="string">&quot;Class&quot;</span> + i, <span class="keyword">null</span>, <span class="string">&quot;java/lang/Object&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">                <span class="comment">// 返回 byte[]</span></span><br><span class="line">                <span class="keyword">byte</span>[] code = cw.toByteArray();</span><br><span class="line">                <span class="comment">// 执行了类的加载</span></span><br><span class="line">                test.defineClass(<span class="string">&quot;Class&quot;</span> + i, code, <span class="number">0</span>, code.length); <span class="comment">// Class 对象</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            System.out.println(j);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>1.8 之后会导致元空间内存溢出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 演示元空间内存溢出 java.lang.OutOfMemoryError: Metaspace</span></span><br><span class="line"><span class="comment">  * -XX:MaxMetaspaceSize=8m</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="comment">// 代码相同 略</span></span><br></pre></td></tr></table></figure>
<p>动态加载/生成类的场景：</p>
<ul>
<li>spring 中存在</li>
<li>mybatis 中存在</li>
<li>...</li>
</ul>
<h3 id="运行时常量池">5.4 运行时常量池</h3>
<blockquote>
<p><strong>反编译代码：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 二进制字节码（类基本信息，常量池，类方法定义，包含了虚拟机指令）</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorld</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;hello world&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译完成后，进入 target 目录找到相应的 .class 文件，采用<code>javap -v HelloWorld.class</code>对其进行反编译</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">C:/.../&gt;javap -v HelloWorld.class</span><br><span class="line"><span class="comment">// 类的基本信息如下：</span></span><br><span class="line">Classfile /C:/.../HelloWorld.class</span><br><span class="line">  Last modified <span class="number">2020</span>-<span class="number">9</span>-<span class="number">9</span>; size <span class="number">547</span> bytes</span><br><span class="line">  MD5 checksum 72b642df992eec6e9c33e4a8b09d4022</span><br><span class="line">  Compiled from <span class="string">&quot;HelloWorld.java&quot;</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">cn</span>.<span class="title">xyc</span>.<span class="title">HelloWorld</span></span></span><br><span class="line"><span class="class">  <span class="title">minor</span> <span class="title">version</span>: 0</span></span><br><span class="line"><span class="class">  <span class="title">major</span> <span class="title">version</span>: 52</span></span><br><span class="line"><span class="class">  <span class="title">flags</span>: <span class="title">ACC_PUBLIC</span>, <span class="title">ACC_SUPER</span></span></span><br><span class="line"><span class="class">// 常量池如下：地址+符号</span></span><br><span class="line"><span class="class"><span class="title">Constant</span> <span class="title">pool</span>: </span></span><br><span class="line"><span class="class">   #1 </span>= Methodref          #<span class="number">6.</span>#<span class="number">20</span>   <span class="comment">// java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">   #<span class="number">2</span> = Fieldref           #<span class="number">21.</span>#<span class="number">22</span>  <span class="comment">// java/lang/System.out:Ljava/io/PrintStream;</span></span><br><span class="line">   #<span class="number">3</span> = String             #<span class="number">23</span>      <span class="comment">// hello world</span></span><br><span class="line">   #<span class="number">4</span> = Methodref          #<span class="number">24.</span>#<span class="number">25</span>  <span class="comment">// java/io/PrintStream.println:(Ljava/lang/String;)V</span></span><br><span class="line">   #<span class="number">5</span> = Class              #<span class="number">26</span>      <span class="comment">// cn/xyc/HelloWorld</span></span><br><span class="line">   #<span class="number">6</span> = Class              #<span class="number">27</span>      <span class="comment">// java/lang/Object</span></span><br><span class="line">   #<span class="number">7</span> = Utf8               &lt;init&gt;</span><br><span class="line">   #<span class="number">8</span> = Utf8               ()V</span><br><span class="line">   #<span class="number">9</span> = Utf8               Code</span><br><span class="line">  #<span class="number">10</span> = Utf8               LineNumberTable</span><br><span class="line">  #<span class="number">11</span> = Utf8               LocalVariableTable</span><br><span class="line">  #<span class="number">12</span> = Utf8               <span class="keyword">this</span></span><br><span class="line">  #<span class="number">13</span> = Utf8               Lcn/xyc/HelloWorld;</span><br><span class="line">  #<span class="number">14</span> = Utf8               main</span><br><span class="line">  #<span class="number">15</span> = Utf8               ([Ljava/lang/String;)V</span><br><span class="line">  #<span class="number">16</span> = Utf8               args</span><br><span class="line">  #<span class="number">17</span> = Utf8               [Ljava/lang/String;</span><br><span class="line">  #<span class="number">18</span> = Utf8               SourceFile</span><br><span class="line">  #<span class="number">19</span> = Utf8               HelloWorld.java</span><br><span class="line">  #<span class="number">20</span> = NameAndType        #<span class="number">7</span>:#<span class="number">8</span>          <span class="comment">// &quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">  #<span class="number">21</span> = Class              #<span class="number">28</span>            <span class="comment">// java/lang/System</span></span><br><span class="line">  #<span class="number">22</span> = NameAndType        #<span class="number">29</span>:#<span class="number">30</span>        <span class="comment">// out:Ljava/io/PrintStream;</span></span><br><span class="line">  #<span class="number">23</span> = Utf8               hello world</span><br><span class="line">  #<span class="number">24</span> = Class              #<span class="number">31</span>            <span class="comment">// java/io/PrintStream</span></span><br><span class="line">  #<span class="number">25</span> = NameAndType        #<span class="number">32</span>:#<span class="number">33</span>        <span class="comment">// println:(Ljava/lang/String;)V</span></span><br><span class="line">  #<span class="number">26</span> = Utf8               cn/xyc/HelloWorld</span><br><span class="line">  #<span class="number">27</span> = Utf8               java/lang/Object</span><br><span class="line">  #<span class="number">28</span> = Utf8               java/lang/System</span><br><span class="line">  #<span class="number">29</span> = Utf8               out</span><br><span class="line">  #<span class="number">30</span> = Utf8               Ljava/io/PrintStream;</span><br><span class="line">  #<span class="number">31</span> = Utf8               java/io/PrintStream</span><br><span class="line">  #<span class="number">32</span> = Utf8               println</span><br><span class="line">  #<span class="number">33</span> = Utf8               (Ljava/lang/String;)V</span><br><span class="line"><span class="comment">// 类中的方法定义如下：</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">public</span> cn.xyc.HelloWorld();  <span class="comment">// 默认构造方法</span></span><br><span class="line">    descriptor: ()V</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=<span class="number">1</span>, locals=<span class="number">1</span>, args_size=<span class="number">1</span></span><br><span class="line">         <span class="number">0</span>: aload_0</span><br><span class="line">         <span class="number">1</span>: invokespecial #<span class="number">1</span>  <span class="comment">// Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">         <span class="number">4</span>: <span class="keyword">return</span></span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line <span class="number">3</span>: <span class="number">0</span></span><br><span class="line">      LocalVariableTable:</span><br><span class="line">        Start  Length  Slot  Name   Signature</span><br><span class="line">            <span class="number">0</span>       <span class="number">5</span>     <span class="number">0</span>  <span class="keyword">this</span>   Lcn/xyc/HelloWorld;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(java.lang.String[])</span></span>;</span><br><span class="line">    descriptor: ([Ljava/lang/String;)V</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=<span class="number">2</span>, locals=<span class="number">1</span>, args_size=<span class="number">1</span></span><br><span class="line">         <span class="comment">// 以下为虚拟机指令：0 3 5 8 -&gt; 4条   #2 表示进行查表翻译，查的即为常量池表</span></span><br><span class="line">         <span class="number">0</span>: getstatic     #<span class="number">2</span>   <span class="comment">// Field java/lang/System.out:Ljava/io/PrintStream;</span></span><br><span class="line">         <span class="number">3</span>: ldc           #<span class="number">3</span>   <span class="comment">// String hello world</span></span><br><span class="line">         <span class="number">5</span>: invokevirtual #<span class="number">4</span>   <span class="comment">// Method java/io/PrintStream.println(Ljava/lang/String;)V</span></span><br><span class="line">         <span class="number">8</span>: <span class="keyword">return</span></span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line <span class="number">5</span>: <span class="number">0</span></span><br><span class="line">        line <span class="number">6</span>: <span class="number">8</span></span><br><span class="line">      LocalVariableTable:</span><br><span class="line">        Start  Length  Slot  Name   Signature</span><br><span class="line">            <span class="number">0</span>       <span class="number">9</span>     <span class="number">0</span>  args   [Ljava/lang/String;</span><br><span class="line">&#125;</span><br><span class="line">SourceFile: <span class="string">&quot;HelloWorld.java&quot;</span></span><br></pre></td></tr></table></figure>
</blockquote>
<ul>
<li><strong>常量池，就是一张表</strong>，虚拟机指令根据这张常量表找到要执行的类名、方法名、参数类型、字面量等信息</li>
<li>运行时常量池，常量池是 <code>*.class</code> 文件中的，当该类被加载，它的常量池信息就会放入运行时常量池，并把里面的符号地址变为真实地址</li>
</ul>
<h3 id="stringtable">5.5 StringTable</h3>
<p>先看几道面试题：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">String s1 = <span class="string">&quot;a&quot;</span>;</span><br><span class="line">String s2 = <span class="string">&quot;b&quot;</span>;</span><br><span class="line">String s3 = <span class="string">&quot;a&quot;</span> + <span class="string">&quot;b&quot;</span>;</span><br><span class="line">String s4 = s1 + s2;</span><br><span class="line">String s5 = <span class="string">&quot;ab&quot;</span>;</span><br><span class="line">String s6 = s4.intern();</span><br><span class="line"><span class="comment">// 问：下面的结果</span></span><br><span class="line">System.out.println(s3 == s4);  <span class="comment">// flase, s3在串池中，而s4在堆中</span></span><br><span class="line">System.out.println(s3 == s5);  <span class="comment">// true，都指向了常量池</span></span><br><span class="line">System.out.println(s3 == s6);  <span class="comment">// true，intern()把对象放入串池，并返回对象</span></span><br><span class="line"></span><br><span class="line">String x2 = <span class="keyword">new</span> String(<span class="string">&quot;c&quot;</span>) + <span class="keyword">new</span> String(<span class="string">&quot;d&quot;</span>);</span><br><span class="line">String x1 = <span class="string">&quot;cd&quot;</span>;</span><br><span class="line">x2.intern();</span><br><span class="line">System.out.println(x1 == x2);  <span class="comment">// false, x1引用了串池中对象，x2为堆中对象</span></span><br><span class="line"><span class="comment">// 问：如果调换了【最后两行代码】的位置呢，如果是jdk1.6呢</span></span><br><span class="line"><span class="comment">// 如果调换x1和x2的位置，即</span></span><br><span class="line"><span class="comment">// x2.intern();</span></span><br><span class="line"><span class="comment">// String x1 = &quot;cd&quot;;</span></span><br><span class="line"><span class="comment">// 此时在jdk1.8中为true、在jdk1.6中为false，详见后续5.6中对于intern的说明</span></span><br><span class="line"><span class="comment">// 即：JDK1.8 调用intern()若串池中没有这个字符串则放入</span></span><br></pre></td></tr></table></figure>
<p><strong>demo1:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 源码</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test8</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String s1 = <span class="string">&quot;a&quot;</span>;  <span class="comment">// 懒惰创建</span></span><br><span class="line">        String s2 = <span class="string">&quot;b&quot;</span>;  <span class="comment">// 懒惰创建</span></span><br><span class="line">        String s3 = <span class="string">&quot;ab&quot;</span>;  <span class="comment">// 懒惰创建</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 反编译结果：</span></span><br><span class="line"><span class="comment">// 常量池：</span></span><br><span class="line">Constant pool:</span><br><span class="line">  #<span class="number">2</span> = String             #<span class="number">25</span>            <span class="comment">// a</span></span><br><span class="line">  #<span class="number">3</span> = String             #<span class="number">26</span>            <span class="comment">// b</span></span><br><span class="line">  #<span class="number">4</span> = String             #<span class="number">27</span>            <span class="comment">// ab</span></span><br><span class="line">  #<span class="number">25</span> = Utf8               a</span><br><span class="line">  #<span class="number">26</span> = Utf8               b</span><br><span class="line">  #<span class="number">27</span> = Utf8               ab</span><br><span class="line"></span><br><span class="line"><span class="comment">// 代码：</span></span><br><span class="line">Code:</span><br><span class="line">  stack=<span class="number">1</span>, locals=<span class="number">4</span>, args_size=<span class="number">1</span></span><br><span class="line">     <span class="number">0</span>: ldc           #<span class="number">2</span>                  <span class="comment">// String a</span></span><br><span class="line">     <span class="number">2</span>: astore_1</span><br><span class="line">     <span class="number">3</span>: ldc           #<span class="number">3</span>                  <span class="comment">// String b</span></span><br><span class="line">     <span class="number">5</span>: astore_2</span><br><span class="line">     <span class="number">6</span>: ldc           #<span class="number">4</span>                  <span class="comment">// String ab</span></span><br><span class="line">     <span class="number">8</span>: astore_3</span><br><span class="line">     <span class="number">9</span>: <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 说明：</span></span><br><span class="line"><span class="comment">//    - 常量池中的信息，都会被加载到运行时常量池中，这时 a b ab 都是常量池中的符号，还没有变为java字符串对象</span></span><br><span class="line"><span class="comment">//    - ldc #2    会把 a 符号变为 “a” 字符串对象，若 StringTable 中不存在，则放入，变为：StringTable[ &quot;a&quot; ]</span></span><br><span class="line"><span class="comment">//    - ldc #3    同上流程，变为：StringTable[ &quot;a&quot;, &quot;b&quot; ]</span></span><br><span class="line"><span class="comment">//    - ldc #4    同上流程，变为：StringTable[ &quot;a&quot;, &quot;b&quot;, &quot;ab&quot; ]</span></span><br><span class="line"><span class="comment">// 注：StringTable 为 hashtable 结构，不能扩容</span></span><br></pre></td></tr></table></figure>
<p><strong>demo2：接上</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 源码</span></span><br><span class="line">String s4 = s1 + s2;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 反编译结果：</span></span><br><span class="line"><span class="comment">// 常量池：</span></span><br><span class="line">Constant pool:</span><br><span class="line">   #<span class="number">2</span> = String             #<span class="number">30</span>  <span class="comment">// a</span></span><br><span class="line">   #<span class="number">3</span> = String             #<span class="number">31</span>  <span class="comment">// b</span></span><br><span class="line">   #<span class="number">4</span> = String             #<span class="number">32</span>  <span class="comment">// ab</span></span><br><span class="line">   #<span class="number">5</span> = Class              #<span class="number">33</span>  <span class="comment">// java/lang/StringBuilder</span></span><br><span class="line">   #<span class="number">6</span> = Methodref          #<span class="number">5.</span>#<span class="number">29</span>  <span class="comment">// java/lang/StringBuilder.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">   #<span class="number">7</span> = Methodref          #<span class="number">5.</span>#<span class="number">34</span>  <span class="comment">// java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;</span></span><br><span class="line">   #<span class="number">8</span> = Methodref          #<span class="number">5.</span>#<span class="number">35</span>  <span class="comment">// java/lang/StringBuilder.toString:()Ljava/lang/String;</span></span><br><span class="line">  #<span class="number">29</span> = NameAndType        #<span class="number">11</span>:#<span class="number">12</span>  <span class="comment">// &quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">  #<span class="number">30</span> = Utf8               a</span><br><span class="line">  #<span class="number">31</span> = Utf8               b</span><br><span class="line">  #<span class="number">32</span> = Utf8               ab</span><br><span class="line">  #<span class="number">33</span> = Utf8               java/lang/StringBuilder</span><br><span class="line">  #<span class="number">34</span> = NameAndType        #<span class="number">38</span>:#<span class="number">39</span>  <span class="comment">// append:(Ljava/lang/String;)Ljava/lang/StringBuilder;</span></span><br><span class="line">  #<span class="number">35</span> = NameAndType        #<span class="number">40</span>:#<span class="number">41</span>  <span class="comment">// toString:()Ljava/lang/String;</span></span><br><span class="line">	</span><br><span class="line"><span class="comment">// 代码：</span></span><br><span class="line">Code:</span><br><span class="line">  stack=<span class="number">2</span>, locals=<span class="number">5</span>, args_size=<span class="number">1</span></span><br><span class="line">     <span class="number">0</span>: ldc           #<span class="number">2</span>  <span class="comment">// String a</span></span><br><span class="line">     <span class="number">2</span>: astore_1</span><br><span class="line">     <span class="number">3</span>: ldc           #<span class="number">3</span>  <span class="comment">// String b</span></span><br><span class="line">     <span class="number">5</span>: astore_2</span><br><span class="line">     <span class="number">6</span>: ldc           #<span class="number">4</span>  <span class="comment">// String ab</span></span><br><span class="line">     <span class="number">8</span>: astore_3</span><br><span class="line">     <span class="number">9</span>: <span class="keyword">new</span>           #<span class="number">5</span>  <span class="comment">// class java/lang/StringBuilder</span></span><br><span class="line">    <span class="number">12</span>: dup</span><br><span class="line">    <span class="number">13</span>: invokespecial #<span class="number">6</span>  <span class="comment">// Method java/lang/StringBuilder.&quot;&lt;init&gt;V</span></span><br><span class="line">    <span class="number">16</span>: aload_1</span><br><span class="line">    <span class="number">17</span>: invokevirtual #<span class="number">7</span>  <span class="comment">// Method java/lang/StringBuilder.append:va/lang/String;)Ljava/lang/StringBuilder;</span></span><br><span class="line">    <span class="number">20</span>: aload_2</span><br><span class="line">    <span class="number">21</span>: invokevirtual #<span class="number">7</span>  <span class="comment">// Method java/lang/StringBuilder.append:va/lang/String;)Ljava/lang/StringBuilder;</span></span><br><span class="line">    <span class="number">24</span>: invokevirtual #<span class="number">8</span>  <span class="comment">// Method java/lang/StringBuilder.toStrinLjava/lang/String;</span></span><br><span class="line">    <span class="number">27</span>: astore        <span class="number">4</span></span><br><span class="line">    <span class="number">29</span>: <span class="keyword">return</span>  </span><br><span class="line">        </span><br><span class="line"><span class="comment">// 总结，上述代码做了如下 String s4 = s1 + s2;</span></span><br><span class="line"><span class="comment">//   new StringBuilder(s1, s2).toString() -&gt; new String(&quot;ab&quot;)</span></span><br></pre></td></tr></table></figure>
<p><strong>demo3：再接上</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 源码</span></span><br><span class="line">String s5 = <span class="string">&quot;a&quot;</span> + <span class="string">&quot;b&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 反编译结果：</span></span><br><span class="line"><span class="comment">// 常量池：</span></span><br><span class="line">Constant pool:</span><br><span class="line">   #<span class="number">4</span> = String             #<span class="number">33</span>  <span class="comment">// ab</span></span><br><span class="line">   #<span class="number">33</span> = Utf8               ab</span><br><span class="line"></span><br><span class="line"><span class="comment">// 代码：</span></span><br><span class="line">Code:</span><br><span class="line">      stack=<span class="number">2</span>, locals=<span class="number">6</span>, args_size=<span class="number">1</span></span><br><span class="line">		<span class="comment">// ...源码对应的指令如下：</span></span><br><span class="line">        <span class="number">29</span>: ldc           #<span class="number">4</span>  <span class="comment">// String ab</span></span><br><span class="line">        <span class="number">31</span>: astore        <span class="number">5</span></span><br><span class="line">        <span class="number">33</span>: <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 分析，对比String s3 = &quot;ab&quot;;</span></span><br><span class="line"><span class="comment">// 其源码为：6: ldc  #4  // String ab</span></span><br><span class="line"><span class="comment">// 同样是寻找常量池中 #4 的位置，因此：</span></span><br><span class="line"><span class="comment">// s3 == s5 的结果为true</span></span><br><span class="line"><span class="comment">// 出于 javac 在编译器的优化，在编译期间，s5的结果已经确定为ab，不会再被修改了</span></span><br></pre></td></tr></table></figure>
<h3 id="stringtable-特性">5.6 StringTable 特性</h3>
<ul>
<li><p>常量池中的字符串仅是符号，<strong>第一次用到时才变为对象</strong></p></li>
<li><p>利用串池的机制，来避免重复创建字符串对象</p>
<blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示字符串字面量也是【延迟】成为对象的</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestString</span> </span>&#123;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">int</span> x = args.length;</span><br><span class="line">           System.out.println(); <span class="comment">// 字符串个数 2275</span></span><br><span class="line"></span><br><span class="line">           System.out.print(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">           System.out.print(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">           System.out.print(<span class="string">&quot;3&quot;</span>);</span><br><span class="line">           System.out.print(<span class="string">&quot;4&quot;</span>);</span><br><span class="line">           System.out.print(<span class="string">&quot;5&quot;</span>);</span><br><span class="line">           System.out.print(<span class="string">&quot;6&quot;</span>);</span><br><span class="line">           System.out.print(<span class="string">&quot;7&quot;</span>);</span><br><span class="line">           System.out.print(<span class="string">&quot;8&quot;</span>);</span><br><span class="line">           System.out.print(<span class="string">&quot;9&quot;</span>);</span><br><span class="line">           System.out.print(<span class="string">&quot;0&quot;</span>);</span><br><span class="line">           System.out.print(<span class="string">&quot;1&quot;</span>); <span class="comment">// 字符串个数 2285</span></span><br><span class="line">           System.out.print(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">           System.out.print(<span class="string">&quot;3&quot;</span>);</span><br><span class="line">           System.out.print(<span class="string">&quot;4&quot;</span>);</span><br><span class="line">           System.out.print(<span class="string">&quot;5&quot;</span>);</span><br><span class="line">           System.out.print(<span class="string">&quot;6&quot;</span>);</span><br><span class="line">           System.out.print(<span class="string">&quot;7&quot;</span>);</span><br><span class="line">           System.out.print(<span class="string">&quot;8&quot;</span>);</span><br><span class="line">           System.out.print(<span class="string">&quot;9&quot;</span>);</span><br><span class="line">           System.out.print(<span class="string">&quot;0&quot;</span>);</span><br><span class="line">           System.out.print(x); <span class="comment">// 字符串个数</span></span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote></li>
<li><p>字符串变量拼接的原理是 StringBuilder （1.8）</p></li>
<li><p><strong>字符串常量拼接的原理是编译期优化</strong></p></li>
<li><p>可以使用 <code>intern()</code> 方法，<strong>主动将串池中还没有的字符串对象放入串池</strong></p>
<ul>
<li>1.8 将这个字符串对象尝试放入串池，如果有则并不会放入，如果没有则<strong>放入串池， 会把串池中的对象返回</strong></li>
<li>1.6 将这个字符串对象尝试放入串池，如果有则并不会放入，如果没有会把此对象复制一份（即<strong>调用intern方法的对象和放入串池的对象是两个对象</strong>），把复制的对象放入串池， 再把串池中的对象返回</li>
</ul></li>
</ul>
<p><strong>对于intern说明：JDK1.8</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    String x = <span class="string">&quot;ab&quot;</span>;</span><br><span class="line">    String s = <span class="keyword">new</span> String(<span class="string">&quot;a&quot;</span>) + <span class="keyword">new</span> String(<span class="string">&quot;b&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    String s2 = s.intern();  <span class="comment">// 会返回串池中的对象</span></span><br><span class="line">    </span><br><span class="line">    System.out.println( s2 == x);  <span class="comment">// true, 都是指向了串池中的对象</span></span><br><span class="line">	System.out.println( s == x );  <span class="comment">// flase，s为堆中的对象</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>说明：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将“ab” 放入串池，此时StringTable为[&quot;ab&quot;]</span></span><br><span class="line">String x = <span class="string">&quot;ab&quot;</span>;</span><br><span class="line"><span class="comment">// &quot;a&quot;, &quot;b&quot; 是常量被放入串池当中, 此时StringTable为[&quot;ab&quot;, &quot;a&quot;, &quot;b&quot;]</span></span><br><span class="line"><span class="comment">// 而new出来的对象在堆中new String(&quot;a&quot;)与new String(&quot;b&quot;)</span></span><br><span class="line"><span class="comment">// 而s仅为堆中的一个对象 String(&quot;ab&quot;)，并不在串池中</span></span><br><span class="line">String s = <span class="keyword">new</span> String(<span class="string">&quot;a&quot;</span>) + <span class="keyword">new</span> String(<span class="string">&quot;b&quot;</span>);</span><br><span class="line"><span class="comment">// 将这个字符串对象尝试放入串池，如果有则并不会放入，如果没有则放入串池,会把串池中的对象返回</span></span><br><span class="line">String s2 = s.intern();</span><br></pre></td></tr></table></figure>
<p><strong>对于intern说明：JDK1.6</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">String s = <span class="keyword">new</span> String(<span class="string">&quot;a&quot;</span>) + <span class="keyword">new</span> String(<span class="string">&quot;b&quot;</span>);</span><br><span class="line"><span class="comment">// 上述执行后：StringTable为[&quot;a&quot;, &quot;b&quot;]</span></span><br><span class="line"><span class="comment">// s为堆中的一个对象 String(&quot;ab&quot;)</span></span><br><span class="line">String s2 = s.intern();  <span class="comment">// 将s拷贝一份放入串池，返回结果为串池中的对象</span></span><br><span class="line">String x = <span class="string">&quot;ab&quot;</span>;  <span class="comment">// x也指向串池中的对象</span></span><br><span class="line">System.out.println( s2 == x);  <span class="comment">// true, 都是指向了串池中的对象</span></span><br><span class="line">System.out.println( s == x );  <span class="comment">// flase，s为堆中的对象</span></span><br></pre></td></tr></table></figure>
<p>而在JDK1.8的环境下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">System.out.println( s2 == x );  <span class="comment">// true, 都是指向了串池中的对象</span></span><br><span class="line">System.out.println( s == x );   <span class="comment">// true，JDK8：s.intern()把这个s对象放入串池，而JDK6则是拷贝s一份放入，因此上述为false，这里为true</span></span><br></pre></td></tr></table></figure>
<h3 id="stringtable-位置">5.7 StringTable 位置</h3>
<p>JDK1.6 中，StringTable 在永久代中；</p>
<p><strong>JDK1.8 中，StringTable 被放入堆中</strong>；</p>
<p>理由如下：</p>
<ul>
<li>永久代中内存回收效率很低，只有在 Full GC 时才会触发垃圾回收；</li>
<li>而堆中，当 Minor GC 时就会触发垃圾回收，大大减轻了常量字符串对内存的占用。</li>
</ul>
<p><strong>证明如下：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示 StringTable 位置</span></span><br><span class="line"><span class="comment"> * 在jdk8下设置 -Xmx10m -XX:-UseGCOverheadLimit</span></span><br><span class="line"><span class="comment"> * 在jdk6下设置 -XX:MaxPermSize=10m  // 设置永久代内存空间</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo1_6</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">260000</span>; j++) &#123;</span><br><span class="line">                <span class="comment">// 把整数转换为String对象后放入StringTable中</span></span><br><span class="line">                list.add(String.valueOf(j).intern());</span><br><span class="line">                i++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            System.out.println(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>JDK1.6结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.lang.OutOfMemoryError: PermGen space</span><br></pre></td></tr></table></figure>
<p>JDK1.8结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -Xmx10m  只设置堆最大内存，报错如下：</span></span><br><span class="line"><span class="comment">// 下述错误是由于花了超过98%的时间来进行GC，而回收的堆空间只是2%</span></span><br><span class="line">java.lang.OutOfMemoryError: GC overhead limit exceeded</span><br><span class="line"><span class="comment">// -Xmx10m -XX:-UseGCOverheadLimit  // 关闭这个开关</span></span><br><span class="line"><span class="comment">// 则错误如下：</span></span><br><span class="line">java.lang.OutOfMemoryError: Java heap space</span><br></pre></td></tr></table></figure>
<h3 id="stringtable-垃圾回收">5.8 StringTable 垃圾回收</h3>
<p><strong>演示代码：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示 StringTable 垃圾回收</span></span><br><span class="line"><span class="comment"> * -Xmx10m -XX:+PrintStringTableStatistics -XX:+PrintGCDetails -verbose:gc</span></span><br><span class="line"><span class="comment"> * JVM参数解释如下：</span></span><br><span class="line"><span class="comment"> *    -Xmx10m：设置堆内存空间最大为10Mb</span></span><br><span class="line"><span class="comment"> *    -XX:+PrintStringTableStatistics： 打印StringTable的统计信息</span></span><br><span class="line"><span class="comment"> *    -XX:+PrintGCDetails -verbose:gc：打印垃圾回收的相应信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo1_7</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            System.out.println(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span></span><br><span class="line">Heap</span><br><span class="line"> PSYoungGen      total 2560K, used 1810K [<span class="number">0x00000000ffd00000</span>, <span class="number">0x0000000100000000</span>, <span class="number">0x0000000100000000</span>)</span><br><span class="line">  eden space 2048K, <span class="number">88</span>% used [<span class="number">0x00000000ffd00000</span>,<span class="number">0x00000000ffec4a50</span>,<span class="number">0x00000000fff00000</span>)</span><br><span class="line">  from space 512K, <span class="number">0</span>% used [<span class="number">0x00000000fff80000</span>,<span class="number">0x00000000fff80000</span>,<span class="number">0x0000000100000000</span>)</span><br><span class="line">  to   space 512K, <span class="number">0</span>% used [<span class="number">0x00000000fff00000</span>,<span class="number">0x00000000fff00000</span>,<span class="number">0x00000000fff80000</span>)</span><br><span class="line"> ParOldGen       total 7168K, used 0K [<span class="number">0x00000000ff600000</span>, <span class="number">0x00000000ffd00000</span>, <span class="number">0x00000000ffd00000</span>)</span><br><span class="line">  object space 7168K, <span class="number">0</span>% used [<span class="number">0x00000000ff600000</span>,<span class="number">0x00000000ff600000</span>,<span class="number">0x00000000ffd00000</span>)</span><br><span class="line"> Metaspace       used 3232K, capacity 4496K, committed 4864K, reserved 1056768K</span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">space</span>    <span class="title">used</span> 350<span class="title">K</span>, <span class="title">capacity</span> 388<span class="title">K</span>, <span class="title">committed</span> 512<span class="title">K</span>, <span class="title">reserved</span> 1048576<span class="title">K</span></span></span><br><span class="line"><span class="class">// 符号表：</span></span><br><span class="line"><span class="class"><span class="title">SymbolTable</span> <span class="title">statistics</span>:</span></span><br><span class="line"><span class="class"><span class="title">Number</span> <span class="title">of</span> <span class="title">buckets</span>       :     20011 </span>=    <span class="number">160088</span> bytes, avg   <span class="number">8.000</span></span><br><span class="line">Number of entries       :     <span class="number">13305</span> =    <span class="number">319320</span> bytes, avg  <span class="number">24.000</span></span><br><span class="line">Number of literals      :     <span class="number">13305</span> =    <span class="number">568576</span> bytes, avg  <span class="number">42.734</span></span><br><span class="line">Total footprint         :           =   <span class="number">1047984</span> bytes</span><br><span class="line">Average bucket size     :     <span class="number">0.665</span></span><br><span class="line">Variance of bucket size :     <span class="number">0.665</span></span><br><span class="line">Std. dev. of bucket size:     <span class="number">0.816</span></span><br><span class="line">Maximum bucket size     :         <span class="number">6</span></span><br><span class="line"><span class="comment">// StringTable信息， hashtable的结构</span></span><br><span class="line">StringTable statistics:</span><br><span class="line"><span class="comment">//                           桶的个数      占用字节量</span></span><br><span class="line">Number of buckets       :     <span class="number">60013</span> =    <span class="number">480104</span> bytes, avg   <span class="number">8.000</span></span><br><span class="line"><span class="comment">// 	                         键值个数      占用字节量     </span></span><br><span class="line">Number of entries       :      <span class="number">1758</span> =     <span class="number">42192</span> bytes, avg  <span class="number">24.000</span></span><br><span class="line"><span class="comment">//                      字符串常量个数      占用字节量  </span></span><br><span class="line">Number of literals      :      <span class="number">1758</span> =    <span class="number">157640</span> bytes, avg  <span class="number">89.670</span></span><br><span class="line"><span class="comment">//                                        总的占用空间   </span></span><br><span class="line">Total footprint         :           =    <span class="number">679936</span> bytes</span><br><span class="line">Average bucket size     :     <span class="number">0.029</span></span><br><span class="line">Variance of bucket size :     <span class="number">0.029</span></span><br><span class="line">Std. dev. of bucket size:     <span class="number">0.172</span></span><br><span class="line">Maximum bucket size     :         <span class="number">3</span></span><br></pre></td></tr></table></figure>
<p>在try块中加入如下：100个常量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">100</span>; j++) &#123; <span class="comment">// j=100, j=10000</span></span><br><span class="line">        String.valueOf(j).intern();</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>StringTable 信息如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">StringTable statistics:</span><br><span class="line">Number of buckets       :     <span class="number">60013</span> =    <span class="number">480104</span> bytes, avg   <span class="number">8.000</span></span><br><span class="line"><span class="comment">// 	                         键值个数增加了100个</span></span><br><span class="line">Number of entries       :      <span class="number">1858</span> =     <span class="number">44592</span> bytes, avg  <span class="number">24.000</span></span><br><span class="line">Number of literals      :      <span class="number">1858</span> =    <span class="number">162440</span> bytes, avg  <span class="number">87.427</span></span><br><span class="line">Total footprint         :           =    <span class="number">687136</span> bytes</span><br><span class="line">Average bucket size     :     <span class="number">0.031</span></span><br><span class="line">Variance of bucket size :     <span class="number">0.031</span></span><br><span class="line">Std. dev. of bucket size:     <span class="number">0.176</span></span><br><span class="line">Maximum bucket size     :         <span class="number">3</span></span><br></pre></td></tr></table></figure>
<p>在try块中加入如下：10000个常量，由于虚拟机对堆空间大小设置为10Mb，因此会出现内存不够的情况，发生垃圾回收</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">10000</span>; j++) &#123; <span class="comment">// j=100, j=10000</span></span><br><span class="line">        String.valueOf(j).intern();</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>StringTable 信息如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">StringTable statistics:</span><br><span class="line">Number of buckets       :     <span class="number">60013</span> =    <span class="number">480104</span> bytes, avg   <span class="number">8.000</span></span><br><span class="line"><span class="comment">// 	                          键值个数并没有增加相应个数，即增加10000个，因为发生了垃圾回收</span></span><br><span class="line">Number of entries       :      <span class="number">5275</span> =    <span class="number">126600</span> bytes, avg  <span class="number">24.000</span></span><br><span class="line">Number of literals      :      <span class="number">5275</span> =    <span class="number">326536</span> bytes, avg  <span class="number">61.903</span></span><br><span class="line">Total footprint         :           =    <span class="number">933240</span> bytes</span><br></pre></td></tr></table></figure>
<p>输出结果中可以看到GC信息如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GC 由于内存空间分配失败，而触发垃圾空间回收</span></span><br><span class="line">[GC (Allocation Failure) [PSYoungGen: 2048K-&gt;504K(2560K)] 2048K-&gt;682K(9728K), <span class="number">0.0015966</span> secs] [Times: user=<span class="number">0.00</span> sys=<span class="number">0.00</span>, real=<span class="number">0.00</span> secs] </span><br></pre></td></tr></table></figure>
<h3 id="stringtable-性能调优">5.9 StringTable 性能调优</h3>
<p><strong>通过控制桶的个数-XX:StringTableSize=xxx</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示串池大小对性能的影响</span></span><br><span class="line"><span class="comment"> * -Xms500m -Xmx500m -XX:+PrintStringTableStatistics -XX:StringTableSize=1009</span></span><br><span class="line"><span class="comment"> * -XX:StringTableSize=1009  设置桶个数大小</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo1_24</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> (BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(<span class="keyword">new</span> FileInputStream(<span class="string">&quot;linux.words&quot;</span>), <span class="string">&quot;utf-8&quot;</span>))) &#123;</span><br><span class="line">            String line = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">long</span> start = System.nanoTime();</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                line = reader.readLine();</span><br><span class="line">                <span class="keyword">if</span> (line == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                line.intern();  <span class="comment">// 将单词放入串池</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 查看入池花费时间</span></span><br><span class="line">            System.out.println(<span class="string">&quot;cost:&quot;</span> + (System.nanoTime() - start) / <span class="number">1000000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>linux.words文件中大致存了48w个单词</p>
</blockquote>
<p>设置桶个数大小为200000w输出如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加虚拟机参数：-Xms500m -Xmx500m -XX:+PrintStringTableStatistics -XX:StringTableSize=200000</span></span><br><span class="line">cost:<span class="number">213</span>  <span class="comment">// 花费时间ms</span></span><br><span class="line">SymbolTable statistics:</span><br><span class="line">Number of buckets       :     <span class="number">20011</span> =    <span class="number">160088</span> bytes, avg   <span class="number">8.000</span></span><br><span class="line">Number of entries       :     <span class="number">13309</span> =    <span class="number">319416</span> bytes, avg  <span class="number">24.000</span></span><br><span class="line">Number of literals      :     <span class="number">13309</span> =    <span class="number">568664</span> bytes, avg  <span class="number">42.728</span></span><br><span class="line">Total footprint         :           =   <span class="number">1048168</span> bytes</span><br><span class="line">Average bucket size     :     <span class="number">0.665</span></span><br><span class="line">Variance of bucket size :     <span class="number">0.666</span></span><br><span class="line">Std. dev. of bucket size:     <span class="number">0.816</span></span><br><span class="line">Maximum bucket size     :         <span class="number">6</span></span><br><span class="line">StringTable statistics:</span><br><span class="line"><span class="comment">//                           桶个数为200000</span></span><br><span class="line">Number of buckets       :    <span class="number">200000</span> =   <span class="number">1600000</span> bytes, avg   <span class="number">8.000</span></span><br><span class="line">Number of entries       :    <span class="number">481510</span> =  <span class="number">11556240</span> bytes, avg  <span class="number">24.000</span></span><br><span class="line">Number of literals      :    <span class="number">481510</span> =  <span class="number">29731304</span> bytes, avg  <span class="number">61.746</span></span><br><span class="line">Total footprint         :           =  <span class="number">42887544</span> bytes</span><br><span class="line">Average bucket size     :     <span class="number">2.408</span></span><br><span class="line">Variance of bucket size :     <span class="number">2.420</span></span><br><span class="line">Std. dev. of bucket size:     <span class="number">1.556</span></span><br><span class="line">Maximum bucket size     :        <span class="number">12</span></span><br></pre></td></tr></table></figure>
<p>默认桶个数（即去掉<code>-XX:StringTableSize=200000</code>），输出如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cost:<span class="number">295</span>  <span class="comment">// 花费时间ms</span></span><br><span class="line">SymbolTable statistics:</span><br><span class="line">Number of buckets       :     <span class="number">20011</span> =    <span class="number">160088</span> bytes, avg   <span class="number">8.000</span></span><br><span class="line">Number of entries       :     <span class="number">13309</span> =    <span class="number">319416</span> bytes, avg  <span class="number">24.000</span></span><br><span class="line">Number of literals      :     <span class="number">13309</span> =    <span class="number">568664</span> bytes, avg  <span class="number">42.728</span></span><br><span class="line">Total footprint         :           =   <span class="number">1048168</span> bytes</span><br><span class="line">Average bucket size     :     <span class="number">0.665</span></span><br><span class="line">Variance of bucket size :     <span class="number">0.666</span></span><br><span class="line">Std. dev. of bucket size:     <span class="number">0.816</span></span><br><span class="line">Maximum bucket size     :         <span class="number">6</span></span><br><span class="line">StringTable statistics:</span><br><span class="line"><span class="comment">//                           桶个数为60013</span></span><br><span class="line">Number of buckets       :     <span class="number">60013</span> =    <span class="number">480104</span> bytes, avg   <span class="number">8.000</span></span><br><span class="line">Number of entries       :    <span class="number">481510</span> =  <span class="number">11556240</span> bytes, avg  <span class="number">24.000</span></span><br><span class="line">Number of literals      :    <span class="number">481510</span> =  <span class="number">29731304</span> bytes, avg  <span class="number">61.746</span></span><br><span class="line">Total footprint         :           =  <span class="number">41767648</span> bytes</span><br><span class="line">Average bucket size     :     <span class="number">8.023</span></span><br><span class="line">Variance of bucket size :     <span class="number">8.085</span></span><br><span class="line">Std. dev. of bucket size:     <span class="number">2.843</span></span><br><span class="line">Maximum bucket size     :        <span class="number">23</span></span><br></pre></td></tr></table></figure>
<p>设置桶个数为1009，结果如下：</p>
<blockquote>
<p>该值范围：<code>StringTable size of 100 is invalid; must be between 1009 and 2305843009213693951</code></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cost:<span class="number">7521</span>  <span class="comment">// 时间明显变慢，即多次发生了哈希碰撞</span></span><br><span class="line">SymbolTable statistics:</span><br><span class="line">Number of buckets       :     <span class="number">20011</span> =    <span class="number">160088</span> bytes, avg   <span class="number">8.000</span></span><br><span class="line">Number of entries       :     <span class="number">13309</span> =    <span class="number">319416</span> bytes, avg  <span class="number">24.000</span></span><br><span class="line">Number of literals      :     <span class="number">13309</span> =    <span class="number">568664</span> bytes, avg  <span class="number">42.728</span></span><br><span class="line">Total footprint         :           =   <span class="number">1048168</span> bytes</span><br><span class="line">Average bucket size     :     <span class="number">0.665</span></span><br><span class="line">Variance of bucket size :     <span class="number">0.666</span></span><br><span class="line">Std. dev. of bucket size:     <span class="number">0.816</span></span><br><span class="line">Maximum bucket size     :         <span class="number">6</span></span><br><span class="line">StringTable statistics:        <span class="comment">// 桶的个数为1009</span></span><br><span class="line">Number of buckets       :      <span class="number">1009</span> =      <span class="number">8072</span> bytes, avg   <span class="number">8.000</span></span><br><span class="line">Number of entries       :    <span class="number">481510</span> =  <span class="number">11556240</span> bytes, avg  <span class="number">24.000</span></span><br><span class="line">Number of literals      :    <span class="number">481510</span> =  <span class="number">29731304</span> bytes, avg  <span class="number">61.746</span></span><br><span class="line">Total footprint         :           =  <span class="number">41295616</span> bytes</span><br><span class="line">Average bucket size     :   <span class="number">477.215</span></span><br><span class="line">Variance of bucket size :   <span class="number">433.737</span></span><br><span class="line">Std. dev. of bucket size:    <span class="number">20.826</span></span><br><span class="line">Maximum bucket size     :       <span class="number">544</span></span><br></pre></td></tr></table></figure>
<p><strong>考虑将字符串对象是否入栈</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示 intern 减少内存占用</span></span><br><span class="line"><span class="comment"> * -XX:StringTableSize=200000 -XX:+PrintStringTableStatistics</span></span><br><span class="line"><span class="comment"> * -Xsx500m -Xmx500m -XX:+PrintStringTableStatistics -XX:StringTableSize=200000</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo1_25</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        List&lt;String&gt; address = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        System.in.read();  <span class="comment">// 等待用户输入</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;  <span class="comment">// 重复10次 将单词读入内存</span></span><br><span class="line">            <span class="keyword">try</span> (BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(<span class="keyword">new</span> FileInputStream(<span class="string">&quot;linux.words&quot;</span>), <span class="string">&quot;utf-8&quot;</span>))) &#123;</span><br><span class="line">                String line = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">long</span> start = System.nanoTime();</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    line = reader.readLine();</span><br><span class="line">                    <span class="keyword">if</span>(line == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    address.add(line); <span class="comment">// 防止被垃圾回收</span></span><br><span class="line">                    <span class="comment">// address.add(line.intern());  // 做一个入池操作</span></span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="string">&quot;cost:&quot;</span> +(System.nanoTime()-start)/<span class="number">1000000</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.in.read();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol type="1">
<li><p>运行程序；</p></li>
<li><p>使用 <code>jvisualvm</code>，选择启动的进程，选择 <strong>抽样器</strong>，选择 <strong>内存</strong>，可以查看内存使用情况，如下：</p>
<p><img src="/2020/09/06/JVM/JVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%EF%BC%9A%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/内存抽样器1.PNG" alt="内存抽样器1"></p>
<p>可以看到此时，String对象占用内存为2.2%</p></li>
<li><p>程序回车，使得单词<code>address.add(line);</code>，此时 <code>String对象+char[]</code> 占用内存可达80%多，且堆中总共使用了约 300Mb 的字节数</p>
<p><img src="/2020/09/06/JVM/JVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%EF%BC%9A%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/内存抽样器2.PNG" alt="内存抽样器2"></p></li>
<li><p>将 String 做一个入池操作，如下：<code>address.add(line.intern());</code>再次运行程序，此时堆占用内存约180Mb，且 <code>String对象+char[]</code> 占用内存可达70%多，相对而言占用堆内存大幅减少</p>
<blockquote>
<p>ps：视频颜色中chra[]数组只占了20%，与String对象相加只占用了40%不到的样子，且用的内存也较本地实验少，原因未知...</p>
</blockquote>
<p><img src="/2020/09/06/JVM/JVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%EF%BC%9A%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/内存抽样器3.PNG" alt="内存抽样器3"></p></li>
</ol>
<p><strong>结论：若应用中有大量的字符串，且字符串可能存在重复问题，可以使得字符串入池来减少堆内存的使用。</strong></p>
<h2 id="直接内存">6. 直接内存</h2>
<h3 id="定义-4">6.1 定义</h3>
<p><strong>Direct Memory</strong></p>
<ul>
<li>常见于 NIO 操作时，用于数据缓冲区</li>
<li>分配回收成本较高，但读写性能高（ByteBuffer 的演示实验）</li>
<li>不受 JVM 内存回收管理，而是系统内存</li>
</ul>
<p><strong>演示 ByteBuffer 作用：-&gt; 读写性能高</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示 ByteBuffer 作用</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo1_9</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String FROM = <span class="string">&quot;D:\\movie\\damingwangchao001.mkv&quot;</span>;  <span class="comment">// 618 MB</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String TO = <span class="string">&quot;D:\\movie\\damingwangchao001-fuben.mkv&quot;</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> _1Mb = <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        io(); <span class="comment">// io 用时：8718.4229  1223.9355  1175.8901</span></span><br><span class="line">        directBuffer(); <span class="comment">// directBuffer 用时：474.8089  786.7621  436.4568</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">io</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> start = System.nanoTime();</span><br><span class="line">        <span class="keyword">try</span> (FileInputStream from = <span class="keyword">new</span> FileInputStream(FROM);</span><br><span class="line">             FileOutputStream to = <span class="keyword">new</span> FileOutputStream(TO);</span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] buf = <span class="keyword">new</span> <span class="keyword">byte</span>[_1Mb];</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> len = from.read(buf);</span><br><span class="line">                <span class="keyword">if</span> (len == -<span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                to.write(buf, <span class="number">0</span>, len);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">long</span> end = System.nanoTime();</span><br><span class="line">        System.out.println(<span class="string">&quot;io 用时：&quot;</span> + (end - start) / <span class="number">1000_000.0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">directBuffer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> start = System.nanoTime();</span><br><span class="line">        <span class="keyword">try</span> (FileChannel from = <span class="keyword">new</span> FileInputStream(FROM).getChannel();</span><br><span class="line">             FileChannel to = <span class="keyword">new</span> FileOutputStream(TO).getChannel();</span><br><span class="line">        ) &#123;</span><br><span class="line">            ByteBuffer bb = ByteBuffer.allocateDirect(_1Mb);</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> len = from.read(bb);</span><br><span class="line">                <span class="keyword">if</span> (len == -<span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                bb.flip();</span><br><span class="line">                to.write(bb);</span><br><span class="line">                bb.clear();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">long</span> end = System.nanoTime();</span><br><span class="line">        System.out.println(<span class="string">&quot;directBuffer 用时：&quot;</span> + (end - start) / <span class="number">1000_000.0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当使用 <code>io()</code> 拷贝文件时：用户需要进行文件读写时，需要调用操作系统提供的函数</p>
<p><img src="/2020/09/06/JVM/JVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%EF%BC%9A%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/文件读写1.PNG" alt="文件读写1"></p>
<p>使用 <code>directBuffer()</code>拷贝文件时：通过<code>ByteBuffer.allocateDirect</code>分配一块<strong>直接内存（direct memory）</strong>，为系统与 java堆共享的一块内存区域</p>
<p><img src="/2020/09/06/JVM/JVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%EF%BC%9A%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/文件读写2.PNG" alt="文件读写2"></p>
<h3 id="分配和回收原理">6.2 分配和回收原理</h3>
<p><strong>直接内存不受 JVM 内存回收管理</strong></p>
<p><strong>演示：演示直接内存溢出</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示直接内存溢出</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo1_10</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> _100Mb = <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        List&lt;ByteBuffer&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                ByteBuffer byteBuffer = ByteBuffer.allocateDirect(_100Mb);</span><br><span class="line">                list.add(byteBuffer);</span><br><span class="line">                i++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            System.out.println(i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 方法区是jvm规范，jdk6 中对方法区的实现称为永久代</span></span><br><span class="line">        <span class="comment">//               jdk8 对方法区的实现称为元空间</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出：错误原因是直接缓冲区内存溢出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">36</span></span><br><span class="line">Exception in thread <span class="string">&quot;main&quot;</span> java.lang.OutOfMemoryError: Direct buffer memory</span><br></pre></td></tr></table></figure>
<p><strong>演示：禁用显式回收对直接内存的影响</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 禁用显式回收对直接内存的影响</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo1_26</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> _1Gb = <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * -XX:+DisableExplicitGC 显式的</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        ByteBuffer byteBuffer = ByteBuffer.allocateDirect(_1Gb);</span><br><span class="line">        System.out.println(<span class="string">&quot;分配完毕...&quot;</span>);</span><br><span class="line">        System.in.read();</span><br><span class="line">        System.out.println(<span class="string">&quot;开始释放...&quot;</span>);</span><br><span class="line">        byteBuffer = <span class="keyword">null</span>;</span><br><span class="line">        System.gc(); <span class="comment">// 显式的垃圾回收，Full GC</span></span><br><span class="line">        System.in.read();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>由于分配的内存为直接内存，故原先的关于java的分析工具已经无法观察到现象了，通过windows中的任务管理器内存进行查看</p>
</blockquote>
<ol type="1">
<li><p>启动程序前内存使用情况：</p>
<p><img src="/2020/09/06/JVM/JVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%EF%BC%9A%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/直接内存分配1.PNG" alt="直接内存分配1"></p></li>
<li><p>启动后，在成功分配内存后，内存的使用情况：</p>
<p><img src="/2020/09/06/JVM/JVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%EF%BC%9A%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/直接内存分配2.PNG" alt="直接内存分配2"></p>
<p>可见，内存多出了1GB的占用；</p></li>
<li><p>将内存释放后的情况：</p>
<p><img src="/2020/09/06/JVM/JVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%EF%BC%9A%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/直接内存分配3.PNG" alt="直接内存分配3"></p>
<p>可见，占用的1GB的直接内存被回收了</p></li>
</ol>
<p>问：直接内存，不受 JVM 内存回收管理，而上述垃圾回收导致了内存被释放，原理如何？</p>
<blockquote>
<p><strong>直接内存分配与回收的底层原理：Unsafe</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 直接内存分配与回收的底层原理：Unsafe</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo1_27</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> _1Gb = <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Unsafe unsafe = getUnsafe();</span><br><span class="line">        <span class="comment">// 分配内存，返回分配的直接内存的地址</span></span><br><span class="line">        <span class="keyword">long</span> base = unsafe.allocateMemory(_1Gb);</span><br><span class="line">        unsafe.setMemory(base, _1Gb, (<span class="keyword">byte</span>) <span class="number">0</span>);</span><br><span class="line">        System.in.read();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 释放直接内存</span></span><br><span class="line">        unsafe.freeMemory(base);</span><br><span class="line">        System.in.read();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Unsafe <span class="title">getUnsafe</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 通过反射创建Unsafe对象</span></span><br><span class="line">            Field f = Unsafe.class.getDeclaredField(<span class="string">&quot;theUnsafe&quot;</span>);</span><br><span class="line">            <span class="comment">// 暴力反射</span></span><br><span class="line">            f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            Unsafe unsafe = (Unsafe) f.get(<span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">return</span> unsafe;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Unsafe类，可以做一些分配直接内存，释放直接内存的操作；</p>
<p>不能直接创建Unsafe对象，只能通过反射创建Unsafe对象</p>
</blockquote>
<p>程序运行时内存的分配与回收效果如上一个程序；</p>
<p>通过<code>unsafe.setMemory</code>分配内存，通过<code>unsafe.freeMemory</code>回收内存，与 JVM 的 GC 回收无用的对象不同，直接内存必须主动进行回收</p>
</blockquote>
<p>对 <code>ByteBuffer</code> 进行源码分析如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.ByteBuffer.allocateDirect(_1Gb);</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ByteBuffer <span class="title">allocateDirect</span><span class="params">(<span class="keyword">int</span> capacity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> DirectByteBuffer(capacity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. DirectByteBuffer</span></span><br><span class="line">DirectByteBuffer(<span class="keyword">int</span> cap) &#123;                   <span class="comment">// package-private</span></span><br><span class="line">    <span class="keyword">super</span>(-<span class="number">1</span>, <span class="number">0</span>, cap, cap);</span><br><span class="line">    <span class="keyword">boolean</span> pa = VM.isDirectMemoryPageAligned();</span><br><span class="line">    <span class="keyword">int</span> ps = Bits.pageSize();</span><br><span class="line">    <span class="keyword">long</span> size = Math.max(<span class="number">1L</span>, (<span class="keyword">long</span>)cap + (pa ? ps : <span class="number">0</span>));</span><br><span class="line">    Bits.reserveMemory(size, cap);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> base = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        base = unsafe.allocateMemory(size);  <span class="comment">// 这里用了unsafe对象，对直接内存进行分配</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (OutOfMemoryError x) &#123;</span><br><span class="line">        Bits.unreserveMemory(size, cap);</span><br><span class="line">        <span class="keyword">throw</span> x;</span><br><span class="line">    &#125;</span><br><span class="line">    unsafe.setMemory(base, size, (<span class="keyword">byte</span>) <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (pa &amp;&amp; (base % ps != <span class="number">0</span>)) &#123;</span><br><span class="line">        <span class="comment">// Round up to page boundary</span></span><br><span class="line">        address = base + ps - (base &amp; (ps - <span class="number">1</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        address = base;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解释见3.与4.</span></span><br><span class="line">    cleaner = Cleaner.create(<span class="keyword">this</span>, <span class="keyword">new</span> Deallocator(base, size, cap));</span><br><span class="line">    att = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. cleaner = Cleaner.create(this, new Deallocator(base, size, cap));</span></span><br><span class="line"><span class="comment">// 3.1 对于回调任务对象new Deallocator(base, size, cap)，如下</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Deallocator</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">static</span> Unsafe unsafe = Unsafe.getUnsafe();</span><br><span class="line"></span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">long</span> address;</span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">long</span> size;</span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">int</span> capacity;</span><br><span class="line"></span><br><span class="line">     <span class="function"><span class="keyword">private</span> <span class="title">Deallocator</span><span class="params">(<span class="keyword">long</span> address, <span class="keyword">long</span> size, <span class="keyword">int</span> capacity)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">assert</span> (address != <span class="number">0</span>);</span><br><span class="line">         <span class="keyword">this</span>.address = address;</span><br><span class="line">         <span class="keyword">this</span>.size = size;</span><br><span class="line">         <span class="keyword">this</span>.capacity = capacity;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">         <span class="keyword">if</span> (address == <span class="number">0</span>) &#123;</span><br><span class="line">             <span class="comment">// Paranoia</span></span><br><span class="line">             <span class="keyword">return</span>;</span><br><span class="line">         &#125;</span><br><span class="line">         unsafe.freeMemory(address);  <span class="comment">// 在这里释放了分配的地址</span></span><br><span class="line">         address = <span class="number">0</span>;</span><br><span class="line">         Bits.unreserveMemory(size, capacity);</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.2 Cleaner对象，在java类库中为一种特殊的类型，称为虚引用类型</span></span><br><span class="line"><span class="comment">// 其特点为：当其关联的对象被回收时，Cleaner会触发clean方法</span></span><br><span class="line"><span class="comment">// 而上述cleaner = Cleaner.create(this, new Deallocator(base, size, cap));</span></span><br><span class="line"><span class="comment">// cleaner 关联的 this 对象为 ByteBuffer，被垃圾回收掉时，触发了Cleaner中的clean方法</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (remove(<span class="keyword">this</span>)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.thunk.run();  <span class="comment">// 这里的run，即上述3.1中的run方法，释放分配空间</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Throwable var2) &#123;</span><br><span class="line">            AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;Void&gt;() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> Void <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (System.err != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        (<span class="keyword">new</span> Error(<span class="string">&quot;Cleaner terminated abnormally&quot;</span>, var2)).printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                    System.exit(<span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>总结：</strong></p>
<ul>
<li>使用了 Unsafe 对象完成直接内存的分配回收，并且回收需要主动调用 freeMemory 方法</li>
<li>ByteBuffer 的实现类内部，<strong>使用了 Cleaner （虚引用）来监测 ByteBuffer 对象</strong>，一旦 ByteBuffer 对象被垃圾回收，那么就会由 ReferenceHandler 线程通过 Cleaner 的 clean 方法调用 freeMemory 来释放直接内存</li>
</ul>
<blockquote>
<p>关于JVM参数：<code>-XX:+DisableExplicitGC</code></p>
<p>一般在做 JVM 调优时，会加入上述参数，参数的作为为：禁用显示的垃圾回收，即让代码中的<code>System.gc();</code>无效；</p>
<p><code>System.gc();</code>相当于通过代码进行一次显示的垃圾回收，而由于该垃圾回收触发的是一次 Full GC，比较影响性能；</p>
<p>但是加上该参数后，会影响到直接内存回收机制，此时 ByteBuffer 不再被显示的回收了，因此 ByteBuffer 只能等到真正的垃圾回收时才会被清理，其对应的直接内存才会被释放掉。</p>
<p>解决方式：直接通过 Unsafe 对象调用 freeMemory 进行内存释放，其手动管理直接内存。</p>
</blockquote>

    </div>

    
    
    
	
	<div>
		
			<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.css">

<div>
    
       <div style="text-align:center;color:#bfbfbf;font-size:16px;">
             <span>--- 本文结束 </span>
             <i class="fa fa-thumbs-o-up"></i>
             <span> 感谢阅读 ---</span>
       </div>
    
</div>
		
	</div>

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="tag"># 学习笔记</a>
              <a href="/tags/JVM/" rel="tag"># JVM</a>
              <a href="/tags/Java/" rel="tag"># Java</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/08/30/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-e/" rel="prev" title="数据结构：学习笔记-e">
      <i class="fa fa-chevron-left"></i> 数据结构：学习笔记-e
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/09/06/JVM/JVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%EF%BC%9A%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/" rel="next" title="JVM：垃圾回收">
      JVM：垃圾回收 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#jvm%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84"><span class="nav-text">JVM：内存结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%AE%B9"><span class="nav-text">内容</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A8%8B%E5%BA%8F%E8%AE%A1%E6%95%B0%E5%99%A8"><span class="nav-text">1. 程序计数器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89"><span class="nav-text">1.1 定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%9C%E7%94%A8"><span class="nav-text">1.2 作用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%A0%88"><span class="nav-text">2. 虚拟机栈</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89-1"><span class="nav-text">2.1 定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%88%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA"><span class="nav-text">2.2 栈内存溢出</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%E9%80%92%E5%BD%92%E7%88%86%E6%A0%88"><span class="nav-text">案例：递归爆栈</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A1%88%E4%BE%8Bjson-%E6%95%B0%E6%8D%AE%E8%BD%AC%E6%8D%A2"><span class="nav-text">案例：json 数据转换</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E8%BF%90%E8%A1%8C%E8%AF%8A%E6%96%AD"><span class="nav-text">2.3 线程运行诊断</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B1cpu%E5%8D%A0%E7%94%A8%E8%BF%87%E5%A4%9A"><span class="nav-text">案例1：CPU占用过多</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B2%E7%A8%8B%E5%BA%8F%E8%BF%90%E8%A1%8C%E5%BE%88%E9%95%BF%E6%97%B6%E9%97%B4%E6%B2%A1%E6%9C%89%E7%BB%93%E6%9E%9C"><span class="nav-text">案例2：程序运行很长时间没有结果</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%AC%E5%9C%B0%E6%96%B9%E6%B3%95%E6%A0%88"><span class="nav-text">3. 本地方法栈</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A0%86"><span class="nav-text">4. 堆</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89-2"><span class="nav-text">4.1 定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A0%86%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA"><span class="nav-text">4.2 堆内存溢出</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A0%86%E5%86%85%E5%AD%98%E8%AF%8A%E6%96%AD"><span class="nav-text">4.3 堆内存诊断</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B1%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8%E6%BC%94%E7%A4%BA"><span class="nav-text">案例1：工具使用演示</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#jmap-%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8"><span class="nav-text">jmap 工具使用</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#jconsole-%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8"><span class="nav-text">jconsole 工具使用</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B2"><span class="nav-text">案例2：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#jvisualvm-%E5%B7%A5%E5%85%B7"><span class="nav-text">jvisualvm 工具</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E5%8C%BA"><span class="nav-text">5. 方法区</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89-3"><span class="nav-text">5.1 定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%84%E6%88%90"><span class="nav-text">5.2 组成</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E5%8C%BA%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA"><span class="nav-text">5.3 方法区内存溢出</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E5%B8%B8%E9%87%8F%E6%B1%A0"><span class="nav-text">5.4 运行时常量池</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#stringtable"><span class="nav-text">5.5 StringTable</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#stringtable-%E7%89%B9%E6%80%A7"><span class="nav-text">5.6 StringTable 特性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#stringtable-%E4%BD%8D%E7%BD%AE"><span class="nav-text">5.7 StringTable 位置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#stringtable-%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6"><span class="nav-text">5.8 StringTable 垃圾回收</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#stringtable-%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98"><span class="nav-text">5.9 StringTable 性能调优</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%B4%E6%8E%A5%E5%86%85%E5%AD%98"><span class="nav-text">6. 直接内存</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89-4"><span class="nav-text">6.1 定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E9%85%8D%E5%92%8C%E5%9B%9E%E6%94%B6%E5%8E%9F%E7%90%86"><span class="nav-text">6.2 分配和回收原理</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="ZhuCC"
      src="/images/%E5%A4%B4%E5%83%8F.jpg">
  <p class="site-author-name" itemprop="name">ZhuCC</p>
  <div class="site-description" itemprop="description">不急不躁。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">161</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">69</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
	  
	  
        <script type="text/javascript" charset="utf-8" src="/js/tagcloud.js"></script>
        <script type="text/javascript" charset="utf-8" src="/js/tagcanvas.js"></script>
        <div class="widget-wrap">
            <div id="myCanvasContainer" class="widget tagcloud">
                <canvas width="250" height="250" id="resCanvas" style="width=100%">
                    <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Anaconda/" rel="tag">Anaconda</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C++</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GPU/" rel="tag">GPU</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/" rel="tag">Git</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GitHub/" rel="tag">GitHub</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP/" rel="tag">HTTP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/" rel="tag">Hexo</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IO/" rel="tag">IO</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JDBC/" rel="tag">JDBC</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JDK/" rel="tag">JDK</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JVM/" rel="tag">JVM</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/" rel="tag">Java</a><span class="tag-list-count">48</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java%E5%9F%BA%E7%A1%80/" rel="tag">Java基础</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java%E8%AF%AD%E6%B3%95/" rel="tag">Java语法</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/K%E8%BF%91%E9%82%BB/" rel="tag">K近邻</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LeetCode/" rel="tag">LeetCode</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Markdown/" rel="tag">Markdown</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MyBatis/" rel="tag">MyBatis</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OSS/" rel="tag">OSS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OpenCV/" rel="tag">OpenCV</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/" rel="tag">Python</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Pytorch/" rel="tag">Pytorch</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring/" rel="tag">Spring</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringBoot/" rel="tag">SpringBoot</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringMVC/" rel="tag">SpringMVC</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TCP-IP/" rel="tag">TCP/IP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TensorFlow/" rel="tag">TensorFlow</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ThreadLocal/" rel="tag">ThreadLocal</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TortoiseGit/" rel="tag">TortoiseGit</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Typora/" rel="tag">Typora</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ubuntu/" rel="tag">Ubuntu</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nvidia/" rel="tag">nvidia</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%86%B3%E7%AD%96%E6%A0%91/" rel="tag">决策树</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%88%86%E7%B1%BB%E9%97%AE%E9%A2%98/" rel="tag">分类问题</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%88%B7%E9%A2%98/" rel="tag">刷题</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/" rel="tag">博客搭建</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8F%82%E8%80%83%E6%96%87%E4%BB%B6/" rel="tag">参考文件</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" rel="tag">基础知识</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="tag">学习笔记</a><span class="tag-list-count">72</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B9%B6%E5%8F%91/" rel="tag">并发</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" rel="tag">并发编程</a><span class="tag-list-count">20</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BC%80%E5%8F%91%E6%A1%86%E6%9E%B6/" rel="tag">开发框架</a><span class="tag-list-count">16</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%8C%81%E4%B9%85%E5%B1%82%E6%A1%86%E6%9E%B6/" rel="tag">持久层框架</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95/" rel="tag">排序算法</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E6%9C%BA/" rel="tag">支持向量机</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E5%AD%A6%E6%8E%A8%E5%AF%BC/" rel="tag">数学推导</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag">数据库</a><span class="tag-list-count">19</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E6%B8%85%E6%B4%97/" rel="tag">数据清洗</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" rel="tag">数据结构</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%97%A5%E5%BF%97%E6%A1%86%E6%9E%B6/" rel="tag">日志框架</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/" rel="tag">机器学习</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%A0%91%E8%8E%93%E6%B4%BE/" rel="tag">树莓派</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" rel="tag">深度学习</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%89%B9%E5%BE%81%E9%80%89%E6%8B%A9/" rel="tag">特征选择</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/" rel="tag">环境配置</a><span class="tag-list-count">15</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B/" rel="tag">目标检测</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%BF%E6%80%A7%E5%9B%9E%E5%BD%92/" rel="tag">线性回归</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%81%9A%E7%B1%BB/" rel="tag">聚类</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%A1%A8%E7%A4%BA%E5%B1%82/" rel="tag">表示层</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E8%B7%AF/" rel="tag">计算机网路</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" rel="tag">读书笔记</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%B4%9D%E5%8F%B6%E6%96%AF/" rel="tag">贝叶斯</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BD%AF%E4%BB%B6%E4%BD%BF%E7%94%A8/" rel="tag">软件使用</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92/" rel="tag">逻辑回归</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9B%86%E5%90%88%E7%B1%BB/" rel="tag">集合类</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9B%86%E6%88%90%E5%AD%A6%E4%B9%A0/" rel="tag">集成学习</a><span class="tag-list-count">1</span></li></ul>
                </canvas>
            </div>
        </div>
      

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ZhuCC</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">2.6m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">39:26</span>
</div>

<!--
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>
-->

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : '3it0tVBbppFeFBVa8QgB3vxM-gzGzoHsz',
      appKey     : '9VtnMWSrhAtC1pSRaA4Rivx9',
      placeholder: "请多多指教~",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
